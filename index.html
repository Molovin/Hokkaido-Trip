<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hokkaido Trip">
    
    <title>Hokkaido Christmas Trip 2025</title>
    
    <link rel="apple-touch-icon" href="https://i.meee.com.tw/m8KEd5j.jpg">
    <link rel="icon" type="image/jpeg" href="https://i.meee.com.tw/m8KEd5j.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        christmas: {
                            red: '#E63946',
                            dark: '#1D3557',
                            light: '#F1FAEE',
                            blue: '#457B9D',
                            snow: '#A8DADC'
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        html, body { height: 100%; overflow: hidden; overscroll-behavior: none; background-color: #1D3557; }
        #app { height: 100dvh; width: 100%; display: flex; flex-direction: column; }
        .header-bg { background-image: url('https://images.microcms-assets.io/assets/14d13bd618dc45c7b684223c0ca9d033/6a65e76092c949d3aaa7fd8a5a2046af/pixta_85703873_M.jpg'); background-size: cover; background-position: center; }
        .header-blur { backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
        .snowflake { position: absolute; top: -20px; color: #fff; pointer-events: none; animation-name: fall; animation-timing-function: linear; animation-iteration-count: infinite; }
        @keyframes fall { 0% { opacity: 0; transform: translate(0, -20px) rotate(0deg); } 10% { opacity: 0.9; } 100% { opacity: 0.2; transform: translate(0, 110vh) rotate(180deg); } }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slider-dot { width: 6px; height: 6px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.4); transition: all 0.3s ease; }
        .slider-dot.active { background-color: white; width: 12px; border-radius: 4px; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #E63946; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="snow-container" class="fixed inset-0 pointer-events-none z-50"></div>

    <div id="app">
        <header class="relative shrink-0 z-20 overflow-hidden rounded-b-[2rem] shadow-xl flex flex-col justify-end transition-all duration-300 pt-[max(env(safe-area-inset-top),20px)] pb-4">
            <div class="absolute inset-0 header-bg"></div>
            <div class="absolute inset-0 bg-christmas-dark/40 header-blur"></div>
            
            <div class="relative z-10 px-6 mt-2">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-christmas-snow text-[10px] font-bold tracking-wider mb-0.5 opacity-90">HOKKAIDO 2025</p>
                        <h1 class="text-2xl font-bold font-serif text-white shadow-black drop-shadow-md">Christmas Trip <i class="fa-solid fa-snowflake text-christmas-snow animate-pulse text-sm"></i></h1>
                    </div>
                    <div class="w-14 h-14 rounded-full bg-yellow-400 overflow-hidden border-2 border-white shadow-sm mb-1">
                        <img src="https://i.meee.com.tw/kYUJZ1x.png" alt="Profile" class="w-full h-full object-cover">
                    </div>
                </div>

                <div v-if="activeTab === 'itinerary'" class="flex space-x-3 overflow-x-auto no-scrollbar pb-1 px-1">
                    <div v-for="(date, index) in dates" :key="index" @click="selectedDate = date.day" :class="['flex-shrink-0 w-20 h-20 rounded-xl flex flex-col items-center justify-center transition-all cursor-pointer border', selectedDate === date.day ? 'bg-christmas-red text-white border-christmas-red transform scale-105 shadow-md' : 'bg-white/10 text-white border-white/20 backdrop-blur-sm']">
                        <span class="text-[10px] opacity-80">{{ date.weekday }}</span>
                        <span class="text-xl font-bold">{{ date.day }}</span>
                    </div>
                </div>
                <div v-else class="mt-1 pb-2">
                    <h2 class="text-lg font-medium text-white opacity-90">{{ tabTitles[activeTab] }}</h2>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar bg-[#f3f4f6] relative z-10 w-full">
            <div class="pt-6 px-4 pb-6">
                <transition name="fade" mode="out-in">
                    <div v-if="activeTab === 'itinerary'" key="itinerary">
                        <div class="flex justify-between items-end mb-4 px-2">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">{{ currentLocationName }} <span class="text-sm font-normal text-gray-500 font-serif ml-2">Dec {{ selectedDate }}</span></h3>
                                <p class="text-[10px] text-christmas-blue/70 mt-1"><i class="fa-solid fa-satellite-dish mr-1"></i>Open-Meteo Áï∂Âú∞ÂØ¶ÊôÇÂ§©Ê∞£</p>
                            </div>
                        </div>
                        <div class="relative min-h-[100px]">
                            <div v-if="weatherLoading" class="absolute inset-0 flex items-center justify-center bg-gray-50/50 z-10 rounded-xl"><div class="loader"></div></div>
                            <div class="flex space-x-3 overflow-x-auto no-scrollbar mb-6 py-2 px-1">
                                <div v-for="(h, i) in hourlyWeather" :key="i" :class="['flex-shrink-0 w-16 h-24 rounded-xl shadow-sm flex flex-col items-center justify-center border transition-all duration-500', i === 0 ? 'bg-blue-50 border-christmas-blue/30 scale-105' : 'bg-white border-transparent']">
                                    <span class="text-[10px] text-gray-400 mb-1">{{ h.time }}</span><i :class="[h.icon, i === 0 ? 'text-christmas-blue' : 'text-yellow-500', 'my-2 text-xl']"></i><span class="text-sm font-bold text-gray-700">{{ h.temp }}¬∞</span><span v-if="i === 0" class="text-[9px] text-christmas-blue font-bold mt-1 bg-blue-100 px-1.5 rounded-full">NOW</span>
                                </div>
                            </div>
                        </div>
                        <div class="relative pl-6 space-y-8 ml-2">
                            <div class="absolute left-[23px] top-2 bottom-0 w-[3px] bg-gradient-to-b from-[#d9888e] via-[#d4af37] to-[#76a5af] shadow-[0_0_8px_rgba(212,175,55,0.4)] rounded-full"></div>
                            <div v-if="filteredItinerary.length === 0" class="py-10 text-center text-gray-400"><i class="fa-regular fa-calendar-xmark text-3xl mb-2 opacity-50"></i><p class="text-xs">ÈÄô‰∏ÄÂ§©ÁõÆÂâçÊ≤íÊúâÂÆâÊéíË°åÁ®ã</p></div>
                            <div v-for="(item, idx) in filteredItinerary" :key="idx" class="relative">
                                <div class="absolute -left-[8px] top-6 w-4 h-4 rounded-full bg-gray-300 border-2 border-white shadow-sm z-10"></div>
                                <div class="bg-white rounded-2xl shadow-sm overflow-hidden ml-4 transform transition hover:scale-[1.01] duration-200">
                                    <div class="h-44 w-full relative group bg-gray-200">
                                        <div v-if="item.images && item.images.length > 1" class="w-full h-full relative">
                                            <div class="flex overflow-x-auto snap-x snap-mandatory w-full h-full no-scrollbar" @scroll="(e) => handleScroll(e, item)">
                                                <img v-for="(img, imgIdx) in item.images" :key="imgIdx" :src="img" @click="openLightbox(img)" class="w-full h-full object-cover flex-shrink-0 snap-center cursor-pointer">
                                            </div>
                                            <div class="absolute bottom-3 left-0 right-0 flex justify-center space-x-1.5 z-20 pointer-events-none"><div v-for="(img, index) in item.images" :key="index" :class="['slider-dot', index === item.currentImageIndex ? 'active' : '']"></div></div>
                                        </div>
                                        <div v-else-if="item.image" class="w-full h-full relative"><img :src="item.image" @click="openLightbox(item.image)" class="w-full h-full object-cover cursor-pointer" referrerpolicy="no-referrer" @error="imageError"></div>
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/30 pointer-events-none"></div>
                                        <div class="absolute top-4 left-4 text-white/90 text-xs font-medium flex items-center shadow-black drop-shadow-sm pointer-events-none"><i class="fa-solid fa-location-dot mr-1.5"></i> {{ item.location }}</div>
                                        <a :href="item.mapLink" target="_blank" class="absolute top-4 right-4 w-8 h-8 bg-white/20 text-white rounded-full flex items-center justify-center backdrop-blur-md border border-white/30 hover:bg-white hover:text-christmas-blue transition-colors z-30 pointer-events-auto"><i class="fa-solid fa-location-arrow text-xs"></i></a>
                                        <div class="absolute bottom-4 left-4 text-white pointer-events-none"><h3 class="text-xl font-bold tracking-wide shadow-black drop-shadow-md">{{ item.title }}</h3></div>
                                        <div class="absolute bottom-4 right-4 bg-black/40 backdrop-blur-md text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center border border-white/20 pointer-events-none"><i class="fa-regular fa-clock mr-1.5"></i> {{ item.time }}</div>
                                    </div>
                                    <div v-if="item.details" class="flex border-b border-gray-100 py-4">
                                        <div class="flex-1 text-center border-r border-gray-100 px-2"><div class="text-[10px] text-christmas-blue font-bold mb-1 tracking-wider">Ë∑ùÈõ¢</div><div class="text-xs text-gray-600 font-bold whitespace-pre-line leading-tight">{{ item.details.distance }}</div></div>
                                        <div class="flex-1 text-center border-r border-gray-100 px-2"><div class="text-[10px] text-christmas-blue font-bold mb-1 tracking-wider">‰∫§ÈÄö</div><div class="text-xs text-gray-600 font-bold leading-tight">{{ item.details.transport }}</div></div>
                                        <div class="flex-1 text-center px-2"><div class="text-[10px] text-christmas-blue font-bold mb-1 tracking-wider">ÂÅúÁïô</div><div class="text-xs text-gray-600 font-bold leading-tight">{{ item.details.stay }}</div></div>
                                    </div>
                                    <div v-if="item.suggestion" class="mx-4 mt-4 bg-yellow-50 rounded-lg p-3 flex items-center text-yellow-700 border border-yellow-100/50"><i class="fa-regular fa-bell mr-3 text-yellow-600"></i><span class="text-xs font-bold">{{ item.suggestion }}</span></div>
                                    <div class="p-4 text-sm text-gray-500 leading-relaxed text-justify">{{ item.desc }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="h-10 text-center text-gray-300 text-xs mt-8">- End of Day -</div>
                    </div>

                    <div v-else-if="activeTab === 'map'" key="map" class="h-full flex flex-col">
                        <div class="bg-white p-2 rounded-xl shadow-sm mb-4 relative">
                            <iframe :src="currentMapUrl" width="100%" height="400" style="border:0; border-radius: 12px;" allowfullscreen="" loading="lazy"></iframe>
                            <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-gray-600 shadow-sm border"><i class="fa-solid fa-map-pin text-christmas-red mr-1"></i> ÈªûÊìä‰∏ãÊñπÂàóË°®Â∞éËà™</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1 overflow-y-auto">
                            <ul class="space-y-2">
                                <li v-for="(loc, idx) in savedLocations" :key="idx" @click="updateMap(loc)" class="flex items-center p-3 rounded-lg hover:bg-gray-50 transition cursor-pointer group border border-transparent hover:border-gray-100">
                                    <div :class="['w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm transition-colors', loc.active ? 'bg-christmas-red text-white' : 'bg-gray-100 text-gray-500 group-hover:bg-white group-hover:text-christmas-red group-hover:shadow-sm']"><i :class="loc.icon"></i></div>
                                    <div class="flex-1"><div :class="['font-bold text-sm transition-colors', loc.active ? 'text-christmas-red' : 'text-gray-700']">{{ loc.name }}</div><div class="text-[10px] text-gray-400">{{ loc.desc }}</div></div>
                                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs group-hover:text-christmas-red group-hover:translate-x-1 transition-all"></i>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div v-else-if="activeTab === 'budget'" key="budget">
                         <div class="bg-gradient-to-r from-christmas-blue to-christmas-dark text-white p-5 rounded-2xl shadow-lg mb-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 rounded-full bg-white/10 blur-xl"></div>
                            <div class="flex justify-between items-start mb-1 relative z-10"><p class="text-sm opacity-80">Total Expenses</p><span class="bg-white/20 px-2 py-0.5 rounded text-[10px] backdrop-blur-sm">‚âà HKD ${{ totalExpenseHkd.toLocaleString() }}</span></div>
                            <h2 class="text-4xl font-bold relative z-10 mb-4 tracking-tight">¬• {{ totalExpense.toLocaleString() }}</h2>
                            <div class="flex gap-2 relative z-10">
                                <div class="bg-white/20 rounded-lg text-xs backdrop-blur-md flex items-center transition-all duration-200 border border-white/10 hover:bg-white/30 h-8">
                                    <div v-if="!isEditingBudget" @click="editBudget" class="px-3 h-full flex items-center cursor-pointer select-none"><span class="opacity-70 mr-1">È†êÁÆó:</span> <span class="font-bold">¬•{{ budgetAmount.toLocaleString() }}</span><i class="fa-solid fa-pen ml-2 text-[10px] opacity-60"></i></div>
                                    <div v-else class="px-1 h-full flex items-center"><span class="pl-2 opacity-70 mr-1">¬•</span><input ref="budgetInputRef" v-model.number="budgetAmount" @blur="saveBudget" @keyup.enter="saveBudget" type="number" class="w-20 bg-transparent text-white font-bold outline-none placeholder-white/50"></div>
                                </div>
                                <div class="bg-white/20 px-3 h-8 flex items-center rounded-lg text-xs backdrop-blur-md border border-white/10"><span class="opacity-70 mr-1">Ââ©È§ò:</span> <span :class="['font-bold', remaining < 0 ? 'text-red-300' : 'text-white']">¬•{{ remaining.toLocaleString() }}</span></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                            <h3 class="font-bold text-gray-700 mb-3 text-sm">Êñ∞Â¢ûÊîØÂá∫</h3>
                            <div class="flex gap-2 mb-2">
                                <input v-model="newExpense.title" type="text" placeholder="È†ÖÁõÆ" class="flex-1 bg-gray-100 p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-christmas-blue min-w-0">
                                <input v-model.number="newExpense.amount" type="number" placeholder="¬•" class="w-28 bg-gray-100 p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-christmas-blue text-center">
                            </div>
                            <button @click="addExpense" class="w-full bg-christmas-red text-white py-2 rounded-lg font-bold text-sm shadow-md active:scale-95 transition">Êñ∞Â¢û</button>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center group">
                                <div class="flex items-center"><div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3 text-lg">{{ getIcon(exp.title) }}</div><div><div class="font-bold text-gray-800">{{ exp.title }}</div><div class="text-xs text-gray-400">{{ exp.date }}</div></div></div>
                                <div class="flex items-center gap-3"><div class="font-bold text-christmas-red">-¬•{{ exp.amount.toLocaleString() }}</div><button @click="deleteExpense(idx)" class="w-6 h-6 rounded-full bg-gray-100 text-gray-400 hover:bg-red-100 hover:text-red-500 flex items-center justify-center transition"><i class="fa-solid fa-trash-can text-xs"></i></button></div>
                            </div>
                            <div v-if="expenses.length === 0" class="text-center text-gray-400 text-xs py-4">ÁõÆÂâçÊ≤íÊúâÊîØÂá∫Á¥ÄÈåÑ</div>
                        </div>
                    </div>

                    <div v-else-if="activeTab === 'shopping'" key="shopping">
                        <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                            <div v-if="newItemImage" class="mb-2 relative w-16 h-16 group">
                                <img :src="newItemImage" class="w-full h-full object-cover rounded-lg border shadow-sm">
                                <button @click="clearImage" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] shadow">√ó</button>
                            </div>
                            <div class="flex gap-3 h-12">
                                <button @click="$refs.fileInput.click()" class="bg-gray-100 text-gray-500 w-14 h-full rounded-lg hover:bg-gray-200 transition flex items-center justify-center">
                                    <i v-if="!isCompressing" class="fa-solid fa-camera"></i>
                                    <div v-else class="loader border-gray-300 border-t-christmas-blue w-4 h-4"></div>
                                </button>
                                <input type="file" ref="fileInput" @change="handleFileChange" accept="image/*" class="hidden">
                                <input v-model="newItem" @keyup.enter="addItem" type="text" placeholder="ÊÉ≥Ë≤∑‰ªÄÈ∫ºÔºü" class="flex-1 h-full bg-gray-100 px-3 rounded-lg outline-none focus:ring-2 focus:ring-christmas-blue text-sm min-w-0">
                                <button @click="addItem" class="bg-christmas-dark text-white w-14 h-full rounded-lg hover:bg-christmas-blue transition flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div v-for="(item, idx) in shoppingList" :key="item.id" :class="['p-4 rounded-xl shadow-sm transition-all relative overflow-hidden group border', item.checked ? 'bg-gray-200 border-transparent' : 'bg-white border-transparent']">
                                <div v-if="item.checked" class="absolute inset-0 flex items-center justify-center bg-black/10 z-10 pointer-events-none"><i class="fa-solid fa-check text-4xl text-green-500 opacity-50"></i></div>
                                <div class="flex justify-between items-start mb-2 relative z-20">
                                    <div v-if="item.image" class="w-10 h-10 rounded-lg overflow-hidden border cursor-pointer" @click.stop="openLightbox(item.image)"><img :src="item.image" class="w-full h-full object-cover"></div>
                                    <i v-else class="fa-solid fa-gift text-christmas-red text-xl"></i>
                                    <div @click.stop="toggleCheck(item)" :class="['w-6 h-6 rounded-full border-2 flex items-center justify-center cursor-pointer transition-colors', item.checked ? 'border-green-500 bg-green-500' : 'border-gray-300 hover:border-green-400']"><i v-if="item.checked" class="fa-solid fa-check text-white text-xs"></i></div>
                                </div>
                                <button @click.stop="deleteShoppingItem(item)" class="absolute top-2 right-10 w-6 h-6 rounded-full bg-white/50 text-gray-400 hover:bg-red-500 hover:text-white flex items-center justify-center z-20 transition shadow-sm"><i class="fa-solid fa-trash-can text-[10px]"></i></button>
                                <h4 :class="['font-bold mt-2 truncate', item.checked ? 'text-gray-500 line-through' : 'text-gray-800']" @click="toggleCheck(item)">{{ item.name }}</h4>
                                <p class="text-xs text-gray-400">ÂøÖË≤∑Ê∏ÖÂñÆ</p>
                            </div>
                        </div>
                        <div v-if="shoppingList.length === 0" class="text-center text-gray-400 text-xs py-10">Ê∏ÖÂñÆÊòØÁ©∫ÁöÑÔºåÂø´ÂéªÂä†ÈªûÊù±Ë•øÔºÅ</div>
                    </div>
                </transition>
            </div>
        </main>

        <div class="shrink-0 bg-[#f3f4f6] z-20 relative">
            <nav class="bg-white w-full px-2 pt-3 pb-[calc(10px+env(safe-area-inset-bottom))] rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.05)] flex justify-around items-center">
                <button @click="activeTab = 'itinerary'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'itinerary' ? 'text-christmas-red' : 'text-gray-400']"><i class="fa-solid fa-calendar-days text-lg"></i><span class="text-[10px] font-bold">Ë°åÁ®ã</span></button>
                <button @click="activeTab = 'map'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'map' ? 'text-christmas-red' : 'text-gray-400']"><i class="fa-solid fa-map-location-dot text-lg"></i><span class="text-[10px] font-bold">Âú∞Âúñ</span></button>
                <button @click="activeTab = 'budget'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'budget' ? 'text-christmas-red' : 'text-gray-400']"><i class="fa-solid fa-wallet text-lg"></i><span class="text-[10px] font-bold">Ë®òÂ∏≥</span></button>
                <button @click="activeTab = 'shopping'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'shopping' ? 'text-christmas-red' : 'text-gray-400']"><i class="fa-solid fa-bag-shopping text-lg"></i><span class="text-[10px] font-bold">Ë≥ºÁâ©</span></button>
            </nav>
        </div>

        <transition name="fade">
            <div v-if="lightboxState.show" class="fixed inset-0 z-[10000] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm" @click="closeLightbox">
                <div class="relative w-full max-w-lg">
                    <img :src="lightboxState.image" class="w-full h-auto rounded-lg shadow-2xl">
                    <button class="absolute -top-12 right-0 text-white bg-white/20 rounded-full w-10 h-10 flex items-center justify-center" @click.stop="closeLightbox"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
            </div>
        </transition>
    </div>

    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick, reactive } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // üî¥ Ë´ãÂ∞áÊÇ®Á¨¨‰∏ÄÈöéÊÆµË§áË£ΩÁöÑ Config Ë≤ºÂú®‰∏ãÊñπ üî¥
        const firebaseConfig = {
  apiKey: "AIzaSyB5ySbzhlf11MhalvIqvQ8dAuNisQmnqi0",
  authDomain: "hokkaido-2025.firebaseapp.com",
  projectId: "hokkaido-2025",
  storageBucket: "hokkaido-2025.firebasestorage.app",
  messagingSenderId: "591604601996",
  appId: "1:591604601996:web:e9e465e2eb0de4bbec17a9"
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        createApp({
            setup() {
                const activeTab = ref('itinerary');
                const selectedDate = ref(20);
                const weatherLoading = ref(false);
                
                // ... (Dates, Map, Weather Logic kept same) ...
                const tabTitles = { 'itinerary': 'Ë°åÁ®ãË°®', 'map': 'Êé¢Á¥¢Âú∞Âúñ', 'budget': 'ÊóÖË°åË®òÂ∏≥', 'shopping': 'Ë≥ºÁâ©Ê∏ÖÂñÆ' };
                const dates = [
                    { day: 20, weekday: 'ÈÄ±ÂÖ≠' }, { day: 21, weekday: 'ÈÄ±Êó•' }, { day: 22, weekday: 'ÈÄ±‰∏Ä' }, 
                    { day: 23, weekday: 'ÈÄ±‰∫å' }, { day: 24, weekday: 'ÈÄ±‰∏â' }, { day: 25, weekday: 'ÈÄ±Âõõ' }, 
                    { day: 26, weekday: 'ÈÄ±‰∫î' }, { day: 27, weekday: 'ÈÄ±ÂÖ≠' }, { day: 28, weekday: 'ÈÄ±Êó•' },
                    { day: 29, weekday: 'ÈÄ±‰∏Ä' }, { day: 30, weekday: 'ÈÄ±‰∫å' }, { day: 31, weekday: 'ÈÄ±‰∏â' }
                ];

                const hourlyWeather = ref([]);
                const getLocationByDate = (date) => {
                    // (Same location logic as before)
                    if (date === 20) return { lat: 35.5494, lon: 139.7798, name: 'Êù±‰∫¨ËΩâÊ©ü (Tokyo)' };
                    if (date === 21) return { lat: 42.5937, lon: 140.8246, name: 'Ê¥ûÁà∫Êπñ (Lake Toya)' };
                    if (date >= 22 && date <= 23) return { lat: 43.0618, lon: 141.3545, name: 'Êú≠Âπå (Sapporo)' };
                    if (date === 24) return { lat: 42.7688, lon: 141.4047, name: 'ÊîØÁ¨èÊπñ (Lake Shikotsu)' };
                    if (date === 25) return { lat: 43.0400, lon: 141.4700, name: 'Êñ∞Êú≠Âπå (Shin-Sapporo)' };
                    if (date === 26) return { lat: 43.1907, lon: 140.9947, name: 'Â∞èÊ®Ω (Otaru)' };
                    if (date === 27) return { lat: 43.5859, lon: 142.4746, name: 'ÁæéÁëõ (Biei)' };
                    if (date === 28) return { lat: 43.0618, lon: 141.3545, name: 'Êú≠Âπå (Sapporo)' };
                    if (date === 29) return { lat: 42.8273, lon: 141.6525, name: 'ÂçÉÊ≠≤ (Chitose)' };
                    if (date >= 30) return { lat: 35.6895, lon: 139.6917, name: 'Êù±‰∫¨ (Tokyo)' };
                    return { lat: 43.0618, lon: 141.3545, name: 'ÂåóÊµ∑ÈÅì (Hokkaido)' };
                }
                const currentLocationName = computed(() => getLocationByDate(selectedDate.value).name);
                const getWeatherIcon = (code) => {
                    if (code <= 1) return 'fa-solid fa-sun'; if (code <= 3) return 'fa-solid fa-cloud-sun'; if (code <= 48) return 'fa-solid fa-smog';
                    if (code <= 67) return 'fa-solid fa-cloud-rain'; if (code <= 77) return 'fa-regular fa-snowflake'; if (code <= 82) return 'fa-solid fa-cloud-showers-heavy';
                    if (code <= 86) return 'fa-solid fa-snowflake'; if (code <= 99) return 'fa-solid fa-bolt'; return 'fa-solid fa-cloud';
                }
                const fetchWeather = async () => {
                    weatherLoading.value = true;
                    try {
                        const loc = getLocationByDate(selectedDate.value);
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&hourly=temperature_2m,weathercode&timezone=Asia%2FTokyo&forecast_days=2`);
                        const data = await response.json();
                        const currentHour = new Date().getHours();
                        const mappedData = [];
                        for(let i = 0; i < 24; i++) {
                            const dataIndex = currentHour + i;
                            if (data.hourly.temperature_2m[dataIndex] !== undefined) {
                                let displayHour = (currentHour + i) % 24;
                                let timeStr = displayHour < 10 ? `0${displayHour}:00` : `${displayHour}:00`;
                                mappedData.push({ time: timeStr, temp: Math.round(data.hourly.temperature_2m[dataIndex]), icon: getWeatherIcon(data.hourly.weathercode[dataIndex]) });
                            }
                        }
                        hourlyWeather.value = mappedData;
                    } catch (e) { hourlyWeather.value = [{ time: 'Error', temp: '--', icon: 'fa-solid fa-triangle-exclamation' }]; } finally { weatherLoading.value = false; }
                }
                watch(selectedDate, () => { fetchWeather(); }, { immediate: true });

                // --- Map & Itinerary Data (Kept same) ---
                const defaultMapUrl = 'https://maps.google.com/maps?q=Hokkaido&z=6&output=embed';
                const currentMapUrl = ref(defaultMapUrl);
                const savedLocations = ref([
                    { name: 'Êú≠ÂπåÈõªË¶ñÂ°î', query: 'Sapporo TV Tower', icon: 'fa-solid fa-tower-broadcast', desc: 'Â§ßÈÄöÂÖ¨ÂúíËÅñË™ïÂ∏ÇÈõÜ', active: false },
                    { name: 'Â∞èÊ®ΩÈÅãÊ≤≥', query: 'Otaru Canal', icon: 'fa-solid fa-water', desc: 'Êµ™Êº´Èõ™ÊôØËàáÁéªÁíÉÂ∑•Ëóù', active: false },
                    { name: 'ÁæéÁëõÈùíÊ±†', query: 'Shirogane Blue Pond', icon: 'fa-solid fa-image', desc: 'ÁæéÁëõÂ§¢ÂπªÈªûÁáà', active: false },
                    { name: 'Êó≠Â±±ÂãïÁâ©Âúí', query: 'Asahiyama Zoo', icon: 'fa-solid fa-paw', desc: '‰ºÅÈµùÊï£Ê≠•', active: false },
                    { name: 'ÁôΩËâ≤ÊàÄ‰∫∫ÂÖ¨Âúí', query: 'Shiroi Koibito Park', icon: 'fa-solid fa-cookie-bite', desc: 'Á´•Ë©±Â∑•Âª†', active: false },
                    { name: 'Êù±‰∫¨ÁæΩÁî∞Ê©üÂ†¥ T2', query: 'Haneda Airport Terminal 2', icon: 'fa-solid fa-plane', desc: 'ËΩâÊ©üËàáË≥ºÁâ©', active: false },
                    { name: 'KEIKYU EX INN', query: 'KEIKYU EX INN Haneda Innovation City', icon: 'fa-solid fa-hotel', desc: 'Á¨¨‰∏ÄÊôö‰ΩèÂÆø', active: false },
                ]);
                const updateMap = (location) => {
                    savedLocations.value.forEach(l => l.active = false); location.active = true;
                    currentMapUrl.value = `https://maps.google.com/maps?q=${encodeURIComponent(location.query)}&z=15&output=embed`;
                };

                const itineraryData = ref([
                    // ... (All previous itinerary data 20-31) ...
                    // Day 28 (Updated)
                    {
                        date: 28,
                        title: 'Ëá™ÁÑ∂ÈÜí & Âá∫Áôº',
                        location: 'ÂéöÂà•Ê∞ëÂÆø',
                        time: '10:00',
                        category: 'Relax',
                        desc: '‰∫´Âèó‰∏ÄÂÄãÁù°Âà∞Ëá™ÁÑ∂ÈÜíÁöÑÊó©Êô®„ÄÇÊÇ†ÈñíÂú∞ÂêÉÈÅéÊó©È§êÂæåÔºåÁ¥Ñ 10:30 Âá∫ÁôºÂâçÂæÄÁ¨¨‰∏ÄÂÄãÊôØÈªû„ÄÇ',
                        icon: 'fa-solid fa-bed',
                        image: 'https://images.unsplash.com/photo-1517849845537-4d257902454a?q=80&w=800',
                        mapLink: '',
                        details: { distance: 'Ê∞ëÂÆø', transport: '‰ºëÊÅØ', stay: 'Ëá≥10:30' }
                    },
                    {
                        date: 28,
                        title: 'Áæä‰πã‰∏òÂ±ïÊúõÂè∞',
                        location: 'Áæä‰πã‰∏ò',
                        time: '10:30',
                        category: 'Sightseeing',
                        desc: 'ËàáËëóÂêçÁöÑÂÖãÊãâÂÖãÂçöÂ£´ÂÉèÂêàÂΩ± ("Boys, be ambitious!")ÔºåÊ¨£Ë≥ûÊú≠ÂπåÂ∏ÇÂçÄÁöÑÈõ™ÊôØÂÖ®ÊôØ„ÄÇ',
                        icon: 'fa-solid fa-binoculars',
                        image: 'https://images.unsplash.com/photo-1534234828563-02622e18926b?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Hitsujigaoka Observation Hill")}',
                        suggestion: 'ÂÖçË≤ªÂÅúËªäÂ†¥',
                        details: { distance: '15km', transport: 'Ëá™Èßï 30ÂàÜ', stay: '1.5Â∞èÊôÇ' }
                    },
                    {
                        date: 28,
                        title: 'ÂçàÈ§êÔºöÊπØÂíñÂì©',
                        location: 'Êú≠ÂπåÂ∏ÇÂçÄ',
                        time: '12:00',
                        category: 'Lunch',
                        desc: 'Âú®ÂâçÂæÄÁ•ûÂÆÆÁöÑÈÄî‰∏≠‰∫´Áî®ÂçàÈ§ê„ÄÇÊé®Ëñ¶ÔºöÂ•ßËäùÂïÜÂ∫óÊàñ Suage+ (Â¶ÇÊûúÈÇÑÊ≤íÂêÉÈÅéÁöÑË©±)„ÄÇ',
                        icon: 'fa-solid fa-utensils',
                        image: 'https://images.unsplash.com/photo-1548943487-a2e4e43b485c?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Suage+ Sapporo")}',
                        details: { distance: 'Â∏ÇÂçÄ', transport: 'Ëá™Èßï', stay: '1.5Â∞èÊôÇ' }
                    },
                    {
                        date: 28,
                        title: 'ÂåóÊµ∑ÈÅìÁ•ûÂÆÆ',
                        location: 'ÂúìÂ±±ÂÖ¨Âúí',
                        time: '13:30',
                        category: 'Sightseeing',
                        desc: 'ÂèÉÊãúÂåóÊµ∑ÈÅìÁ∏ΩÈéÆÂÆà„ÄÇÂÜ¨Â§©ÁöÑÁ•ûÂÆÆÂú®Èõ™‰∏≠È°ØÂæóÊ†ºÂ§ñËéäÂö¥ÂØßÈùú„ÄÇ',
                        icon: 'fa-solid fa-torii-gate',
                        image: 'https://images.unsplash.com/photo-1570459027562-4a916cc6113f?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Hokkaido Shrine")}',
                        suggestion: 'ÂÅúËªäË≤ªÔºöÂèÉÊãúËÄÖÂÖçË≤ª1Â∞èÊôÇ',
                        details: { distance: '10km', transport: 'Ëá™Èßï 20ÂàÜ', stay: '1.5Â∞èÊôÇ' }
                    },
                    {
                        date: 28,
                        title: 'ÁôΩËâ≤ÊàÄ‰∫∫ÂÖ¨Âúí (ÈªûÁáà)',
                        location: 'Êú≠ÂπåË•øÂçÄ',
                        time: '15:30',
                        category: 'Sightseeing',
                        desc: 'ÂÇçÊôöÂâçÂæÄÔºåÂâõÂ•ΩÂèØ‰ª•Ê¨£Ë≥ûÊà∂Â§ñÁöÑËÅñË™ïÈªûÁáà (Illumination)ÔºåÈùûÂ∏∏Êµ™Êº´„ÄÇ',
                        icon: 'fa-solid fa-cookie-bite',
                        image: 'https://images.unsplash.com/photo-1611029289297-c2447952a20b?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Shiroi Koibito Park")}',
                        suggestion: '‰ªòË≤ªÂÅúËªäÂ†¥ (1000ÂÜÜ/h)',
                        details: { distance: '15ÂàÜ', transport: 'Ëá™Èßï', stay: '1.5Â∞èÊôÇ' }
                    },
                    {
                        date: 28,
                        title: 'Ëø¥ËΩâÂ£ΩÂè∏ Toriton (ÊôöÈ§ê)',
                        location: 'Ë±êÂπ≥Â∫ó (Â•ΩÂÅúËªä)',
                        time: '18:00',
                        category: 'Dinner',
                        desc: 'ÂåóÊµ∑ÈÅìÁï∂Âú∞‰∫∫Ê∞£Á¨¨‰∏ÄÁöÑËø¥ËΩâÂ£ΩÂè∏ÔºÅÈ£üÊùêÊñ∞ÈÆÆ„ÄÅ‰ªΩÈáèÂ§ß„ÄÇÊé®Ëñ¶ÔºöÁîüÂπ≤Ë≤ù„ÄÅÂ§ßÁâ°‰∏πËù¶„ÄÇ',
                        icon: 'fa-solid fa-fish',
                        image: 'https://tblg.k-img.com/restaurant/images/Rvw/136030/640x640_rect_136030097.jpg',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Toriton Toyohira")}',
                        suggestion: 'ÁÑ°Ê≥ïÈ†êÁ¥ÑÔºåÂª∫Ë≠∞ÊèêÊó©ÂéªÊäΩËôüÁ¢ºÁâå',
                        details: { distance: 'Â∏ÇÂçÄ', transport: 'Ëá™Èßï 20ÂàÜ', stay: '1.5Â∞èÊôÇ' }
                    },
                    // ... (Other days same) ...
                ]);
                const filteredItinerary = computed(() => itineraryData.value.filter(item => item.date === selectedDate.value));

                // --- Expense & Budget (Local Storage) ---
                const savedExpenses = localStorage.getItem('trip_expenses');
                const expenses = ref(savedExpenses ? JSON.parse(savedExpenses) : [{ title: 'Ê©üÂ†¥ÊòüÂ∑¥ÂÖã', amount: 800, date: '12/20' }]);
                const savedBudget = localStorage.getItem('trip_budget');
                const budgetAmount = ref(savedBudget ? JSON.parse(savedBudget) : 200000);
                const isEditingBudget = ref(false);
                const budgetInputRef = ref(null);
                
                watch(expenses, (newVal) => localStorage.setItem('trip_expenses', JSON.stringify(newVal)), { deep: true });
                watch(budgetAmount, (newVal) => localStorage.setItem('trip_budget', JSON.stringify(newVal)));

                const newExpense = ref({ title: '', amount: '' });
                const addExpense = () => { if(newExpense.value.title && newExpense.value.amount) { expenses.value.unshift({ title: newExpense.value.title, amount: newExpense.value.amount, date: '12/' + selectedDate.value }); newExpense.value = { title: '', amount: '' }; } };
                const deleteExpense = (index) => { if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÊîØÂá∫ÂóéÔºü')) expenses.value.splice(index, 1); };
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                const remaining = computed(() => budgetAmount.value - totalExpense.value);
                const totalExpenseHkd = computed(() => (totalExpense.value * 0.052).toFixed(0));
                const editBudget = () => { isEditingBudget.value = true; nextTick(() => { if(budgetInputRef.value) budgetInputRef.value.focus(); }); };
                const saveBudget = () => { isEditingBudget.value = false; if(budgetAmount.value < 0) budgetAmount.value = 0; };
                const getIcon = (title) => { if(title.includes('È£ü') || title.includes('ÊãâÈ∫µ')) return 'üçú'; return 'üí∏'; };

                // --- Shopping Logic (FIREBASE INTEGRATED) ---
                const shoppingList = ref([]);
                const newItem = ref('');
                const newItemImage = ref(null);
                const newItemImageBlob = ref(null);
                const isCompressing = ref(false);

                // Load Data from Firestore Real-time
                onMounted(() => {
                    const q = query(collection(db, "shopping_list"), orderBy("createdAt", "desc"));
                    onSnapshot(q, (snapshot) => {
                        shoppingList.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                });

                // 1. Image Compression Logic
                const resizeImage = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const maxWidth = 800;
                                let width = img.width;
                                let height = img.height;
                                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                                canvas.width = width; canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                                canvas.toBlob((blob) => { resolve({ blob, url: canvas.toDataURL('image/jpeg', 0.8) }); }, 'image/jpeg', 0.8);
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                };

                const handleFileChange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        isCompressing.value = true;
                        try {
                            const result = await resizeImage(file);
                            newItemImage.value = result.url; // For preview
                            newItemImageBlob.value = result.blob; // For upload
                        } catch (error) { console.error(error); alert("ÂúñÁâáËôïÁêÜÂ§±Êïó"); } finally { isCompressing.value = false; }
                    }
                };

                const clearImage = () => { newItemImage.value = null; newItemImageBlob.value = null; };

                // 2. Add Item to Firestore + Storage
                const addItem = async () => {
                    if (!newItem.value) return;
                    let imageUrl = null;
                    
                    if (newItemImageBlob.value) {
                        isCompressing.value = true; // reuse loading state
                        try {
                            const storageRefName = `shopping_images/${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`;
                            const imgRef = storageRef(storage, storageRefName);
                            const snapshot = await uploadBytes(imgRef, newItemImageBlob.value);
                            imageUrl = await getDownloadURL(snapshot.ref);
                        } catch (e) {
                            console.error("Upload failed", e);
                            alert("ÂúñÁâá‰∏äÂÇ≥Â§±ÊïóÔºå‰ΩÜ‰ªçÊúÉÊñ∞Â¢ûÊñáÂ≠óÈ†ÖÁõÆ");
                        } finally {
                            isCompressing.value = false;
                        }
                    }

                    try {
                        await addDoc(collection(db, "shopping_list"), {
                            name: newItem.value,
                            checked: false,
                            image: imageUrl,
                            createdAt: Date.now()
                        });
                        newItem.value = '';
                        clearImage();
                    } catch (e) {
                        console.error("Firestore Error", e);
                    }
                };

                // 3. Delete Item from Firestore
                const deleteShoppingItem = async (item) => {
                    if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÈ†ÖÁõÆÂóéÔºü')) {
                        await deleteDoc(doc(db, "shopping_list", item.id));
                        // Optional: Delete image from storage to save space, but not strictly required for test mode
                    }
                };

                // 4. Toggle Check
                const toggleCheck = async (item) => {
                    await updateDoc(doc(db, "shopping_list", item.id), { checked: !item.checked });
                };

                // --- Lightbox ---
                const lightboxState = reactive({ show: false, image: '' });
                const openLightbox = (imgUrl) => { lightboxState.image = imgUrl; lightboxState.show = true; }
                const closeLightbox = () => { lightboxState.show = false; }
                const imageError = (e) => { e.target.src = 'https://placehold.co/600x400?text=No+Image'; } // Fixed error

                // --- Snow ---
                onMounted(() => {
                    // ... (Snow animation kept same) ...
                    const snowContainer = document.getElementById('snow-container');
                    const createSnowflake = () => {
                        const snowflake = document.createElement('div');
                        snowflake.classList.add('snowflake');
                        snowflake.innerHTML = Math.random() > 0.5 ? '‚ùÑ' : '‚Ä¢';
                        snowflake.style.left = Math.random() * 100 + 'vw';
                        const size = Math.random() * 8 + 6; 
                        snowflake.style.fontSize = size + 'px';
                        snowflake.style.opacity = Math.random() * 0.5 + 0.3;
                        snowflake.style.animationDuration = (Math.random() * 10 + 15) + 's';
                        snowflake.style.animationDelay = Math.random() * 5 + 's';
                        snowContainer.appendChild(snowflake);
                        setTimeout(() => snowflake.remove(), 25000); 
                    };
                    for(let i=0; i<8; i++) setTimeout(createSnowflake, i * 500);
                    setInterval(createSnowflake, 800);
                });

                return {
                    activeTab, dates, selectedDate, hourlyWeather, filteredItinerary,
                    expenses, newExpense, addExpense, deleteExpense, totalExpense, getIcon,
                    budgetAmount, isEditingBudget, editBudget, saveBudget, budgetInputRef, remaining, totalExpenseHkd,
                    shoppingList, newItem, addItem, deleteShoppingItem, newItemImage, handleFileChange, tabTitles, imageError,
                    currentLocationName, weatherLoading, lightboxState, openLightbox, closeLightbox, handleScroll,
                    currentMapUrl, savedLocations, updateMap, isCompressing, clearImage, toggleCheck
                }
            }
        }).mount('#app')
    </script>
</body>
</html>