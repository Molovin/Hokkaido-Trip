<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hokkaido Trip">
    
    <title>Hokkaido Christmas Trip 2025</title>
    
    <link rel="apple-touch-icon" href="https://i.meee.com.tw/m8KEd5j.jpg">
    <link rel="icon" type="image/jpeg" href="https://i.meee.com.tw/m8KEd5j.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        christmas: {
                            red: '#E63946',
                            dark: '#1D3557',
                            light: '#F1FAEE',
                            blue: '#457B9D',
                            snow: '#A8DADC'
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        html, body {
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
            background-color: #1D3557; 
        }

        #app {
            height: 100dvh; 
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .header-bg {
            background-image: url('https://images.microcms-assets.io/assets/14d13bd618dc45c7b684223c0ca9d033/6a65e76092c949d3aaa7fd8a5a2046af/pixta_85703873_M.jpg');
            background-size: cover;
            background-position: center;
        }
        
        .header-blur {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .snowflake {
            position: absolute;
            top: -20px;
            color: #fff;
            user-select: none;
            z-index: 9999;
            pointer-events: none;
            will-change: transform;
            animation-name: fall;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        @keyframes fall {
            0% { opacity: 0; transform: translate(0, -20px) rotate(0deg); }
            10% { opacity: 0.9; }
            25% { transform: translate(25px, 20vh) rotate(45deg); }
            50% { transform: translate(-25px, 50vh) rotate(90deg); }
            75% { transform: translate(25px, 80vh) rotate(135deg); }
            100% { opacity: 0.2; transform: translate(0, 110vh) rotate(180deg); }
        }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .slider-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
        }
        .slider-dot.active {
            background-color: white;
            width: 12px;
            border-radius: 4px;
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #E63946;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="snow-container" class="fixed inset-0 pointer-events-none z-50"></div>

    <div id="app">
        <header class="relative shrink-0 z-20 overflow-hidden rounded-b-[2rem] shadow-xl flex flex-col justify-end transition-all duration-300 pt-[max(env(safe-area-inset-top),20px)] pb-4">
            <div class="absolute inset-0 header-bg"></div>
            <div class="absolute inset-0 bg-christmas-dark/40 header-blur"></div>
            
            <div class="relative z-10 px-6 mt-2">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-christmas-snow text-[10px] font-bold tracking-wider mb-0.5 opacity-90">HOKKAIDO 2025</p>
                        <h1 class="text-2xl font-bold font-serif text-white shadow-black drop-shadow-md">Christmas Trip <i class="fa-solid fa-snowflake text-christmas-snow animate-pulse text-sm"></i></h1>
                    </div>
                    <div class="w-14 h-14 rounded-full bg-yellow-400 overflow-hidden border-2 border-white shadow-sm mb-1">
                        <img src="https://i.meee.com.tw/kYUJZ1x.png" alt="Profile" class="w-full h-full object-cover">
                    </div>
                </div>

                <div v-if="activeTab === 'itinerary'" class="flex space-x-3 overflow-x-auto no-scrollbar pb-1 px-1">
                    <div v-for="(date, index) in dates" :key="index" 
                         @click="selectedDate = date.day"
                         :class="['flex-shrink-0 w-20 h-20 rounded-xl flex flex-col items-center justify-center transition-all cursor-pointer border', 
                         selectedDate === date.day ? 'bg-christmas-red text-white border-christmas-red transform scale-105 shadow-md' : 'bg-white/10 text-white border-white/20 backdrop-blur-sm']">
                        <span class="text-[10px] opacity-80">{{ date.weekday }}</span>
                        <span class="text-xl font-bold">{{ date.day }}</span>
                    </div>
                </div>
                <div v-else class="mt-1 pb-2">
                    <h2 class="text-lg font-medium text-white opacity-90">{{ tabTitles[activeTab] }}</h2>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar bg-[#f3f4f6] relative z-10 w-full">
            <div class="pt-6 px-4 pb-6">
                <transition name="fade" mode="out-in">
                    
                    <div v-if="activeTab === 'itinerary'" key="itinerary">
                        <div class="flex justify-between items-end mb-4 px-2">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">{{ currentLocationName }} <span class="text-sm font-normal text-gray-500 font-serif ml-2">Dec {{ selectedDate }}</span></h3>
                                <p class="text-[10px] text-christmas-blue/70 mt-1"><i class="fa-solid fa-satellite-dish mr-1"></i>Open-Meteo 當地實時天氣</p>
                            </div>
                        </div>

                        <div class="relative min-h-[100px]">
                            <div v-if="weatherLoading" class="absolute inset-0 flex items-center justify-center bg-gray-50/50 z-10 rounded-xl">
                                <div class="loader"></div>
                            </div>
                            <div class="flex space-x-3 overflow-x-auto no-scrollbar mb-6 py-2 px-1">
                                <div v-for="(h, i) in hourlyWeather" :key="i" 
                                     :class="['flex-shrink-0 w-16 h-24 rounded-xl shadow-sm flex flex-col items-center justify-center border transition-all duration-500', 
                                     i === 0 ? 'bg-blue-50 border-christmas-blue/30 scale-105' : 'bg-white border-transparent']">
                                    <span class="text-[10px] text-gray-400 mb-1">{{ h.time }}</span>
                                    <i :class="[h.icon, i === 0 ? 'text-christmas-blue' : 'text-yellow-500', 'my-2 text-xl']"></i>
                                    <span class="text-sm font-bold text-gray-700">{{ h.temp }}°</span>
                                    <span v-if="i === 0" class="text-[9px] text-christmas-blue font-bold mt-1 bg-blue-100 px-1.5 rounded-full">NOW</span>
                                </div>
                            </div>
                        </div>

                        <div class="relative pl-6 space-y-8 ml-2">
                            
                            <div class="absolute left-[23px] top-2 bottom-0 w-[3px] bg-gradient-to-b from-[#d9888e] via-[#d4af37] to-[#76a5af] shadow-[0_0_8px_rgba(212,175,55,0.4)] rounded-full"></div>

                            <div v-if="filteredItinerary.length === 0" class="py-10 text-center text-gray-400">
                                <i class="fa-regular fa-calendar-xmark text-3xl mb-2 opacity-50"></i>
                                <p class="text-xs">這一天目前沒有安排行程</p>
                            </div>

                            <div v-for="(item, idx) in filteredItinerary" :key="idx" class="relative">
                                
                                <div class="absolute -left-[8px] top-6 w-4 h-4 rounded-full bg-gray-300 border-2 border-white shadow-sm z-10"></div>
                                
                                <div class="bg-white rounded-2xl shadow-sm overflow-hidden ml-4 transform transition hover:scale-[1.01] duration-200">
                                    
                                    <div class="h-44 w-full relative group bg-gray-200">
                                        <div v-if="item.images && item.images.length > 1" class="w-full h-full relative">
                                            <div class="flex overflow-x-auto snap-x snap-mandatory w-full h-full no-scrollbar"
                                                 @scroll="(e) => handleScroll(e, item)">
                                                <img v-for="(img, imgIdx) in item.images" :key="imgIdx"
                                                     :src="img"
                                                     @click="openLightbox(img)"
                                                     class="w-full h-full object-cover flex-shrink-0 snap-center cursor-pointer">
                                            </div>
                                            <div class="absolute bottom-3 left-0 right-0 flex justify-center space-x-1.5 z-20 pointer-events-none">
                                                <div v-for="(img, index) in item.images" :key="index"
                                                     :class="['slider-dot', index === item.currentImageIndex ? 'active' : '']"></div>
                                            </div>
                                        </div>
                                        
                                        <div v-else-if="item.image" class="w-full h-full relative">
                                            <img :src="item.image" 
                                                 @click="openLightbox(item.image)"
                                                 class="w-full h-full object-cover cursor-pointer"
                                                 referrerpolicy="no-referrer" @error="imageError">
                                        </div>

                                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/30 pointer-events-none"></div>
                                        
                                        <div class="absolute top-4 left-4 text-white/90 text-xs font-medium flex items-center shadow-black drop-shadow-sm pointer-events-none">
                                            <i class="fa-solid fa-location-dot mr-1.5"></i> {{ item.location }}
                                        </div>

                                        <a :href="item.mapLink" target="_blank" class="absolute top-4 right-4 w-8 h-8 bg-white/20 text-white rounded-full flex items-center justify-center backdrop-blur-md border border-white/30 hover:bg-white hover:text-christmas-blue transition-colors z-30 pointer-events-auto">
                                            <i class="fa-solid fa-location-arrow text-xs"></i>
                                        </a>

                                        <div class="absolute bottom-4 left-4 text-white pointer-events-none">
                                            <h3 class="text-xl font-bold tracking-wide shadow-black drop-shadow-md">{{ item.title }}</h3>
                                        </div>
                                        <div class="absolute bottom-4 right-4 bg-black/40 backdrop-blur-md text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center border border-white/20 pointer-events-none">
                                            <i class="fa-regular fa-clock mr-1.5"></i> {{ item.time }}
                                        </div>
                                    </div>
                                    
                                    <div v-if="item.details" class="flex border-b border-gray-100 py-4">
                                        <div class="flex-1 text-center border-r border-gray-100 px-2">
                                            <div class="text-[10px] text-christmas-blue font-bold mb-1 tracking-wider">距離</div>
                                            <div class="text-xs text-gray-600 font-bold whitespace-pre-line leading-tight">{{ item.details.distance }}</div>
                                        </div>
                                        <div class="flex-1 text-center border-r border-gray-100 px-2">
                                            <div class="text-[10px] text-christmas-blue font-bold mb-1 tracking-wider">交通</div>
                                            <div class="text-xs text-gray-600 font-bold leading-tight">{{ item.details.transport }}</div>
                                        </div>
                                        <div class="flex-1 text-center px-2">
                                            <div class="text-[10px] text-christmas-blue font-bold mb-1 tracking-wider">停留</div>
                                            <div class="text-xs text-gray-600 font-bold leading-tight">{{ item.details.stay }}</div>
                                        </div>
                                    </div>

                                    <div v-if="item.suggestion" class="mx-4 mt-4 bg-yellow-50 rounded-lg p-3 flex items-center text-yellow-700 border border-yellow-100/50">
                                        <i class="fa-regular fa-bell mr-3 text-yellow-600"></i>
                                        <span class="text-xs font-bold">{{ item.suggestion }}</span>
                                    </div>

                                    <div class="p-4 text-sm text-gray-500 leading-relaxed text-justify">
                                        {{ item.desc }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="h-10 text-center text-gray-300 text-xs mt-8">- End of Day -</div>
                    </div>

                    <div v-else-if="activeTab === 'map'" key="map" class="h-full flex flex-col">
                        <div class="bg-white p-2 rounded-xl shadow-sm mb-4 relative">
                            <iframe 
                                :src="currentMapUrl" 
                                width="100%" height="400" 
                                style="border:0; border-radius: 12px;" 
                                allowfullscreen="" loading="lazy">
                            </iframe>
                            <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-gray-600 shadow-sm border">
                                <i class="fa-solid fa-map-pin text-christmas-red mr-1"></i> 點擊下方列表導航
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1 overflow-y-auto">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800">Saved Locations <span class="text-gray-400 text-xs font-normal">({{ savedLocations.length }})</span></h3>
                                <button class="text-christmas-blue text-xs font-bold">View All</button>
                            </div>
                            <ul class="space-y-2">
                                <li v-for="(loc, idx) in savedLocations" :key="idx" 
                                    @click="updateMap(loc)"
                                    class="flex items-center p-3 rounded-lg hover:bg-gray-50 transition cursor-pointer group border border-transparent hover:border-gray-100">
                                    <div :class="['w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm transition-colors', 
                                        loc.active ? 'bg-christmas-red text-white' : 'bg-gray-100 text-gray-500 group-hover:bg-white group-hover:text-christmas-red group-hover:shadow-sm']">
                                        <i :class="loc.icon"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div :class="['font-bold text-sm transition-colors', loc.active ? 'text-christmas-red' : 'text-gray-700']">{{ loc.name }}</div>
                                        <div class="text-[10px] text-gray-400">{{ loc.desc }}</div>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs group-hover:text-christmas-red group-hover:translate-x-1 transition-all"></i>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div v-else-if="activeTab === 'budget'" key="budget">
                         <div class="bg-gradient-to-r from-christmas-blue to-christmas-dark text-white p-5 rounded-2xl shadow-lg mb-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 rounded-full bg-white/10 blur-xl"></div>
                            <div class="flex justify-between items-start mb-1 relative z-10">
                                <p class="text-sm opacity-80">Total Expenses</p>
                                <span class="bg-white/20 px-2 py-0.5 rounded text-[10px] backdrop-blur-sm">≈ HKD ${{ totalExpenseHkd.toLocaleString() }}</span>
                            </div>
                            <h2 class="text-4xl font-bold relative z-10 mb-4 tracking-tight">¥ {{ totalExpense.toLocaleString() }}</h2>
                            <div class="flex gap-2 relative z-10">
                                <div class="bg-white/20 rounded-lg text-xs backdrop-blur-md flex items-center transition-all duration-200 border border-white/10 hover:bg-white/30 h-8">
                                    <div v-if="!isEditingBudget" @click="editBudget" class="px-3 h-full flex items-center cursor-pointer select-none">
                                        <span class="opacity-70 mr-1">預算:</span> 
                                        <span class="font-bold">¥{{ budgetAmount.toLocaleString() }}</span>
                                        <i class="fa-solid fa-pen ml-2 text-[10px] opacity-60"></i>
                                    </div>
                                    <div v-else class="px-1 h-full flex items-center">
                                        <span class="pl-2 opacity-70 mr-1">¥</span>
                                        <input ref="budgetInputRef" v-model.number="budgetAmount" @blur="saveBudget" @keyup.enter="saveBudget" type="number" class="w-20 bg-transparent text-white font-bold outline-none placeholder-white/50">
                                    </div>
                                </div>
                                <div class="bg-white/20 px-3 h-8 flex items-center rounded-lg text-xs backdrop-blur-md border border-white/10">
                                    <span class="opacity-70 mr-1">剩餘:</span> 
                                    <span :class="['font-bold', remaining < 0 ? 'text-red-300' : 'text-white']">¥{{ remaining.toLocaleString() }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                            <h3 class="font-bold text-gray-700 mb-3 text-sm">新增支出</h3>
                            <div class="flex gap-2 mb-2">
                                <input v-model="newExpense.title" type="text" placeholder="項目" class="flex-1 bg-gray-100 p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-christmas-blue min-w-0">
                                <input v-model.number="newExpense.amount" type="number" placeholder="¥" class="w-28 bg-gray-100 p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-christmas-blue text-center">
                            </div>
                            <button @click="addExpense" class="w-full bg-christmas-red text-white py-2 rounded-lg font-bold text-sm shadow-md active:scale-95 transition">新增</button>
                        </div>

                        <div class="space-y-3">
                            <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center group">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3 text-lg">{{ getIcon(exp.title) }}</div>
                                    <div><div class="font-bold text-gray-800">{{ exp.title }}</div><div class="text-xs text-gray-400">{{ exp.date }}</div></div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="font-bold text-christmas-red">-¥{{ exp.amount.toLocaleString() }}</div>
                                    <button @click="deleteExpense(idx)" class="w-6 h-6 rounded-full bg-gray-100 text-gray-400 hover:bg-red-100 hover:text-red-500 flex items-center justify-center transition">
                                        <i class="fa-solid fa-trash-can text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-if="expenses.length === 0" class="text-center text-gray-400 text-xs py-4">目前沒有支出紀錄</div>
                        </div>
                    </div>

                    <div v-else-if="activeTab === 'shopping'" key="shopping">
                        <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                            <div v-if="newItemImage" class="mb-2 relative w-16 h-16 group">
                                <img :src="newItemImage" class="w-full h-full object-cover rounded-lg border shadow-sm">
                                <button @click="newItemImage = null" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] shadow">×</button>
                            </div>

                            <div class="flex gap-3 h-12">
                                <button @click="$refs.fileInput.click()" class="bg-gray-100 text-gray-500 w-14 h-full rounded-lg hover:bg-gray-200 transition flex items-center justify-center">
                                    <i class="fa-solid fa-camera"></i>
                                </button>
                                <input type="file" ref="fileInput" @change="handleFileChange" accept="image/*" class="hidden">

                                <input v-model="newItem" @keyup.enter="addItem" type="text" placeholder="想買什麼？" class="flex-1 h-full bg-gray-100 px-3 rounded-lg outline-none focus:ring-2 focus:ring-christmas-blue text-sm min-w-0">
                                <button @click="addItem" class="bg-christmas-dark text-white w-14 h-full rounded-lg hover:bg-christmas-blue transition flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div v-for="(item, idx) in shoppingList" :key="idx" 
                                 :class="['p-4 rounded-xl shadow-sm transition-all relative overflow-hidden group border', item.checked ? 'bg-gray-200 border-transparent' : 'bg-white border-transparent']">
                                
                                <div v-if="item.checked" class="absolute inset-0 flex items-center justify-center bg-black/10 z-10 pointer-events-none">
                                    <i class="fa-solid fa-check text-4xl text-green-500 opacity-50"></i>
                                </div>

                                <div class="flex justify-between items-start mb-2 relative z-20">
                                    <div v-if="item.image" class="w-10 h-10 rounded-lg overflow-hidden border cursor-pointer" @click.stop="openLightbox(item.image)">
                                        <img :src="item.image" class="w-full h-full object-cover">
                                    </div>
                                    <i v-else class="fa-solid fa-gift text-christmas-red text-xl"></i>
                                    
                                    <div @click.stop="item.checked = !item.checked" 
                                         :class="['w-6 h-6 rounded-full border-2 flex items-center justify-center cursor-pointer transition-colors', item.checked ? 'border-green-500 bg-green-500' : 'border-gray-300 hover:border-green-400']">
                                        <i v-if="item.checked" class="fa-solid fa-check text-white text-xs"></i>
                                    </div>
                                </div>
                                
                                <button @click.stop="deleteShoppingItem(idx)" class="absolute top-2 right-10 w-6 h-6 rounded-full bg-white/50 text-gray-400 hover:bg-red-500 hover:text-white flex items-center justify-center z-20 transition shadow-sm">
                                    <i class="fa-solid fa-trash-can text-[10px]"></i>
                                </button>

                                <h4 :class="['font-bold mt-2 truncate', item.checked ? 'text-gray-500 line-through' : 'text-gray-800']" @click="item.checked = !item.checked">{{ item.name }}</h4>
                                <p class="text-xs text-gray-400">必買清單</p>
                            </div>
                        </div>
                        <div v-if="shoppingList.length === 0" class="text-center text-gray-400 text-xs py-10">清單是空的，快去加點東西！</div>
                    </div>
                </transition>
            </div>
        </main>

        <div class="shrink-0 bg-[#f3f4f6] z-20 relative">
            <nav class="bg-white w-full px-2 pt-3 pb-[calc(10px+env(safe-area-inset-bottom))] rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.05)] flex justify-around items-center">
                <button @click="activeTab = 'itinerary'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'itinerary' ? 'text-christmas-red' : 'text-gray-400']">
                    <i class="fa-solid fa-calendar-days text-lg"></i><span class="text-[10px] font-bold">行程</span>
                </button>
                <button @click="activeTab = 'map'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'map' ? 'text-christmas-red' : 'text-gray-400']">
                    <i class="fa-solid fa-map-location-dot text-lg"></i><span class="text-[10px] font-bold">地圖</span>
                </button>
                <button @click="activeTab = 'budget'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'budget' ? 'text-christmas-red' : 'text-gray-400']">
                    <i class="fa-solid fa-wallet text-lg"></i><span class="text-[10px] font-bold">記帳</span>
                </button>
                <button @click="activeTab = 'shopping'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'shopping' ? 'text-christmas-red' : 'text-gray-400']">
                    <i class="fa-solid fa-bag-shopping text-lg"></i><span class="text-[10px] font-bold">購物</span>
                </button>
            </nav>
        </div>

        <transition name="fade">
            <div v-if="lightboxState.show" class="fixed inset-0 z-[10000] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm" @click="closeLightbox">
                <div class="relative w-full max-w-lg">
                    <img :src="lightboxState.image" class="w-full h-auto rounded-lg shadow-2xl">
                    <button class="absolute -top-12 right-0 text-white bg-white/20 rounded-full w-10 h-10 flex items-center justify-center" @click.stop="closeLightbox">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, nextTick, reactive } = Vue

        createApp({
            setup() {
                const activeTab = ref('itinerary')
                const selectedDate = ref(20)
                const weatherLoading = ref(false)
                
                const tabTitles = { 'itinerary': '行程表', 'map': '探索地圖', 'budget': '旅行記帳', 'shopping': '購物清單' }
                
                const dates = [
                    { day: 20, weekday: '週六' }, { day: 21, weekday: '週日' }, { day: 22, weekday: '週一' }, 
                    { day: 23, weekday: '週二' }, { day: 24, weekday: '週三' }, { day: 25, weekday: '週四' }, 
                    { day: 26, weekday: '週五' }, { day: 27, weekday: '週六' }, { day: 28, weekday: '週日' },
                    { day: 29, weekday: '週一' }, { day: 30, weekday: '週二' }
                ]

                // --- Map Feature ---
                const defaultMapUrl = 'https://maps.google.com/maps?q=Hokkaido&z=6&output=embed';
                const currentMapUrl = ref(defaultMapUrl);
                const savedLocations = ref([
                    { name: '札幌電視塔', query: 'Sapporo TV Tower', icon: 'fa-solid fa-tower-broadcast', desc: '大通公園聖誕市集', active: false },
                    { name: '小樽運河', query: 'Otaru Canal', icon: 'fa-solid fa-water', desc: '浪漫雪景與玻璃工藝', active: false },
                    { name: '星野度假村 Tomamu', query: 'Hoshino Resorts Tomamu', icon: 'fa-solid fa-person-skiing', desc: '滑雪、愛絲冰城', active: false },
                    { name: '函館山夜景', query: 'Mount Hakodate', icon: 'fa-solid fa-star', desc: '百萬夜景', active: false },
                    { name: '白金青池', query: 'Shirogane Blue Pond', icon: 'fa-solid fa-image', desc: '美瑛夢幻雪景', active: false },
                    { name: '東京羽田機場 T2', query: 'Haneda Airport Terminal 2', icon: 'fa-solid fa-plane', desc: '轉機與購物', active: false },
                    { name: 'KEIKYU EX INN', query: 'KEIKYU EX INN Haneda Innovation City', icon: 'fa-solid fa-hotel', desc: '第一晚住宿', active: false },
                ]);
                const updateMap = (location) => {
                    savedLocations.value.forEach(l => l.active = false);
                    location.active = true;
                    currentMapUrl.value = `https://maps.google.com/maps?q=${encodeURIComponent(location.query)}&z=15&output=embed`;
                };

                // --- Weather Logic ---
                const hourlyWeather = ref([])
                const getLocationByDate = (date) => {
                    if (date === 20) return { lat: 35.5494, lon: 139.7798, name: '東京轉機 (Tokyo)' };
                    if (date === 21) return { lat: 42.5937, lon: 140.8246, name: '洞爺湖 (Lake Toya)' };
                    if (date === 22) return { lat: 43.0618, lon: 141.3545, name: '札幌 (Sapporo)' };
                    if (date === 23) return { lat: 43.0618, lon: 141.3545, name: '札幌 (Sapporo)' };
                    if (date === 24) return { lat: 42.7688, lon: 141.4047, name: '支笏湖 (Lake Shikotsu)' }; // Day 24: Lake Shikotsu
                    if (date === 25) return { lat: 43.0400, lon: 141.4700, name: '新札幌 (Shin-Sapporo)' }; // Day 25: Shin-Sapporo
                    return { lat: 43.0618, lon: 141.3545, name: '北海道 (Hokkaido)' };
                }
                const currentLocationName = computed(() => getLocationByDate(selectedDate.value).name)
                const getWeatherIcon = (code) => {
                    if (code <= 1) return 'fa-solid fa-sun';
                    if (code <= 3) return 'fa-solid fa-cloud-sun';
                    if (code <= 48) return 'fa-solid fa-smog';
                    if (code <= 67) return 'fa-solid fa-cloud-rain';
                    if (code <= 77) return 'fa-regular fa-snowflake';
                    if (code <= 82) return 'fa-solid fa-cloud-showers-heavy';
                    if (code <= 86) return 'fa-solid fa-snowflake';
                    if (code <= 99) return 'fa-solid fa-bolt';
                    return 'fa-solid fa-cloud';
                }
                const fetchWeather = async () => {
                    weatherLoading.value = true;
                    try {
                        const loc = getLocationByDate(selectedDate.value);
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&hourly=temperature_2m,weathercode&timezone=Asia%2FTokyo&forecast_days=2`);
                        const data = await response.json();
                        const currentHour = new Date().getHours();
                        const mappedData = [];
                        for(let i = 0; i < 24; i++) {
                            const dataIndex = currentHour + i;
                            if (data.hourly.temperature_2m[dataIndex] !== undefined) {
                                let displayHour = (currentHour + i) % 24;
                                let timeStr = `${displayHour}:00`;
                                if(displayHour < 10) timeStr = `0${displayHour}:00`;
                                mappedData.push({
                                    time: timeStr,
                                    temp: Math.round(data.hourly.temperature_2m[dataIndex]),
                                    icon: getWeatherIcon(data.hourly.weathercode[dataIndex])
                                });
                            }
                        }
                        hourlyWeather.value = mappedData;
                    } catch (e) {
                        hourlyWeather.value = [{ time: 'Error', temp: '--', icon: 'fa-solid fa-triangle-exclamation' }];
                    } finally {
                        weatherLoading.value = false;
                    }
                }
                watch(selectedDate, () => { fetchWeather(); }, { immediate: true })

                // --- Lightbox Logic ---
                const lightboxState = reactive({ show: false, image: '' });
                const openLightbox = (imgUrl) => { lightboxState.image = imgUrl; lightboxState.show = true; }
                const closeLightbox = () => { lightboxState.show = false; }

                // --- Scroll Sync Logic ---
                const handleScroll = (e, item) => {
                    const scrollLeft = e.target.scrollLeft;
                    const width = e.target.clientWidth;
                    const newIndex = Math.round(scrollLeft / width);
                    if (item.currentImageIndex !== newIndex) {
                        item.currentImageIndex = newIndex;
                    }
                }

                // --- Itinerary Data ---
                const itineraryData = ref([
                    // Day 20
                    {
                        date: 20, 
                        title: '廣州往東京 (NH924)',
                        location: '廣州白雲國際機場 T1',
                        time: '15:05',
                        category: 'Flight',
                        desc: '航班 : ANA NH924。預訂參考編號 : XK6OCG。機型舒適，飛行時間 3小時55分。',
                        icon: 'fa-solid fa-plane-departure',
                        image: 'https://dayooimg.dayoo.com/www/202402/06/54628485_bfb1e75b-3a34-491c-befd-52c4a4a38c11.jpg', 
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Haneda+Airport', 
                        suggestion: '建議到達時間 : 12:35',
                        details: { distance: '飛行距離\n2,900 km', transport: '3小時55分', stay: '航程' }
                    },
                    {
                        date: 20, 
                        title: '抵達東京 (羽田機場)',
                        location: '羽田機場 T2',
                        time: '20:00',
                        category: 'Arrival',
                        desc: '抵達羽田機場第2航廈 (T2)。辦理入境手續，感受日本冬日氣息。',
                        icon: 'fa-solid fa-location-dot',
                        image: 'https://lh7-us.googleusercontent.com/WjfbIrlhtJ-Z7HwnV6h7fXSfhk0ZOgfZG-fI7yJ4MqxAPtXYUoj6L3RUnAxWS6rqfjNEEgscg0NPRJutSOZS3LW_50-XEycs8gIHwrEafiIMImvLvbYBtTo5HaJtXBii3Nxro_y-sYXR9aGcCkeHdUU',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Haneda+Airport+Terminal+2',
                        details: { distance: '機場內', transport: '步行', stay: '1小時' }
                    },
                    {
                        date: 20, 
                        title: '入住 KEIKYU EX INN',
                        location: 'KEIKYU EX INN',
                        time: '21:30',
                        category: 'Hotel',
                        desc: '地址：1-1-4 Haneda Airport。位於天空橋站 HICity 出口步行2分鐘。備有大浴場可放鬆身心。',
                        icon: 'fa-solid fa-bed',
                        images: [
                            'https://pix8.agoda.net/hotelImages/16791240/803978242/bc74de46d2361212f60426dc71338600.jpg?ce=0&s=1024x',
                            'https://pix8.agoda.net/hotelImages/16791240/803978242/b69c0182316827d1c477e36427be07c3.jpg?ce=0&s=1024x',
                            'https://pix8.agoda.net/hotelImages/16791240/803978242/1bd9a4da30ccb7860ad744bfa3f47ae3.jpg?ce=0&s=1024x'
                        ],
                        currentImageIndex: 0,
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=KEIKYU+EX+INN+Haneda', 
                        details: { distance: '一站距離', transport: '電車/接駁', stay: '過夜' }
                    },
                    
                    // Day 21
                    {
                        date: 21,
                        title: '飛往札幌 (新千歲)',
                        location: '羽田機場 -> 新千歲',
                        time: '08:00',
                        category: 'Flight',
                        desc: '搭乘早班機前往北海道新千歲機場，準備開始自駕之旅！',
                        icon: 'fa-solid fa-plane',
                        image: 'https://images.unsplash.com/photo-1548181655-46e326292b0c?q=80&w=600&auto=format&fit=crop',
                        mapLink: 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d321',
                        suggestion: '建議到達時間 : 06:30 (需於 06:15 從 KEIKYU EX INN 出發)',
                        details: { distance: '820km', transport: '1h 30m', stay: '航程' }
                    },
                    {
                        date: 21,
                        title: 'Budget 租車取車',
                        location: '新千歲機場店',
                        time: '10:00',
                        category: 'Car Rental',
                        desc: '前往 Budget 櫃檯辦理取車手續。檢查車況、安裝雪胎，準備出發！',
                        icon: 'fa-solid fa-car',
                        image: 'https://www.budgetrentacar.co.jp/common/images/shop/0700/0700_main.jpg',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Budget Car Rental New Chitose")}',
                        details: { distance: '機場接駁', transport: '接駁車', stay: '30分' }
                    },
                    {
                        date: 21,
                        title: '午餐：北海道湯咖哩',
                        location: '千歲市區 / 機場',
                        time: '11:30',
                        category: 'Lunch',
                        desc: '抵達北海道的第一餐，當然要吃熱騰騰的湯咖哩暖胃！推薦嘗試 Rojiura Curry SAMURAI 或 Lavi。',
                        icon: 'fa-solid fa-utensils',
                        image: 'https://images.unsplash.com/photo-1548943487-a2e4e43b485c?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Rojiura Curry SAMURAI Chitose")}',
                        details: { distance: '市區內', transport: '自駕', stay: '1.5小時' }
                    },
                    {
                        date: 21,
                        title: '登別地獄谷',
                        location: '登別溫泉',
                        time: '14:00',
                        category: 'Sightseeing',
                        desc: '觀賞火山爆發後形成的火山口遺跡，煙霧繚繞，景色壯觀。空氣中瀰漫著濃濃的硫磺味。',
                        icon: 'fa-solid fa-volcano',
                        image: 'https://images.unsplash.com/photo-1627883393922-a7f474966627?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Noboribetsu Jigokudani")}',
                        details: { distance: '60km', transport: '自駕 1h', stay: '1.5小時' }
                    },
                    {
                        date: 21,
                        title: '入住 Hotel Cocoa',
                        location: '洞爺湖',
                        time: '18:00',
                        category: 'Hotel',
                        desc: '抵達洞爺湖畔的 Hotel Cocoa。享受湖景與舒適的住宿環境，放鬆一天的疲憊。',
                        icon: 'fa-solid fa-hotel',
                        images: [
                            'https://q-xx.bstatic.com/xdata/images/hotel/840x460/445146130.jpg?k=f502e84c5929f5529ae905690d6b97012de0fff071b942fd1301ab4aa008b541&o=&s=1024x',
                            'https://pix8.agoda.net/hotelImages/26079610/410029220/fd0b49e14e153112c980fa9fc78aba7f.jpg?ce=2&s=1024x',
                            'https://pix8.agoda.net/hotelImages/26079610/410029220/1dbe30d5b439f5476c1881a794cc5aea.jpg?ce=2&s=1024x'
                        ],
                        currentImageIndex: 0,
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Hotel Cocoa Toyako")}',
                        details: { distance: '50km', transport: '自駕 1h', stay: '過夜' }
                    },

                    // Day 22
                    {
                        date: 22,
                        title: '洞爺湖晨間散策',
                        location: '洞爺湖畔',
                        time: '09:30',
                        category: 'Sightseeing',
                        desc: '早晨在湖邊漫步，欣賞羊蹄山的倒影。推薦前往 Lake Hill Farm 品嚐新鮮的義式冰淇淋。',
                        icon: 'fa-solid fa-camera',
                        image: 'https://images.unsplash.com/photo-1614343152528-94e09581827e?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Lake Toya")}',
                        details: { distance: '周邊', transport: '自駕', stay: '2小時' }
                    },
                    {
                        date: 22,
                        title: '前往札幌 & 午餐',
                        location: '往札幌途中',
                        time: '12:00',
                        category: 'Drive',
                        desc: '享用午餐後，驅車前往北海道第一大城——札幌。沿途欣賞雪國公路風光。',
                        icon: 'fa-solid fa-car-side',
                        image: 'https://images.unsplash.com/photo-1542931287-023b922fa89b?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Sapporo")}',
                        details: { distance: '100km', transport: '自駕 2h', stay: '車程' }
                    },
                    {
                        date: 22,
                        title: '滑雪體驗 (天氣許可)',
                        location: '札幌手稻滑雪場',
                        time: '15:30',
                        category: 'Activity',
                        desc: '如果天氣狀況良好，前往市區附近的滑雪場體驗粉雪！(推薦：札幌手稻或札幌國際滑雪場)',
                        icon: 'fa-solid fa-person-skiing',
                        image: 'https://images.unsplash.com/photo-1551524559-8af4e6624178?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Sapporo Teine Ski Resort")}',
                        suggestion: '視當日風雪狀況決定',
                        details: { distance: '20km', transport: '自駕 40分', stay: '2-3小時' }
                    },
                    {
                        date: 22,
                        title: '入住 Airbnb',
                        location: '札幌市區',
                        time: '19:00',
                        category: 'Stay',
                        desc: '入住位於札幌的 Airbnb 民宿。連住兩晚，方便探索市區美食與聖誕市集。',
                        icon: 'fa-solid fa-house-user',
                        images: [
                            'https://a0.muscache.com/im/pictures/hosting/Hosting-U3RheVN1cHBseUxpc3Rpbmc6MTUwOTg5OTcyODkyNTI1Mjk4Mg==/original/6a9e98b6-f65e-4c79-a37c-6fe7e2c19f9f.png?im_w=1440',
                            'https://a0.muscache.com/im/pictures/hosting/Hosting-U3RheVN1cHBseUxpc3Rpbmc6MTUwOTg5OTcyODkyNTI1Mjk4Mg==/original/0891bfb0-08b3-4138-8b19-aada9920e40d.png?im_w=1440'
                        ],
                        currentImageIndex: 0,
                        mapLink: 'https://www.airbnb.com/l/B6IGd7Ac',
                        details: { distance: '市區', transport: '自駕', stay: '連住兩晚' }
                    },

                    // Day 23
                    {
                        date: 23,
                        title: '國營瀧野鈴蘭丘陵公園',
                        location: '札幌南區',
                        time: '09:30',
                        category: 'Activity',
                        desc: '冬季開園首日！盡情體驗長達200公尺的輪胎滑雪(Tube Sledding)、雪地漫步等雪上活動。',
                        icon: 'fa-solid fa-snowflake',
                        image: 'https://images.unsplash.com/photo-1518659685799-923cb7a2a07d?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Takino Suzuran Hillside Park")}',
                        details: { distance: '20km', transport: '自駕 45分', stay: '3小時' }
                    },
                    {
                        date: 23,
                        title: '午餐：Restaurant Moai',
                        location: '真駒內瀧野靈園',
                        time: '12:30',
                        category: 'Sightseeing',
                        desc: '探訪安藤忠雄設計的「頭大佛」與壯觀的摩艾石像群。午餐可在園區內的 Restaurant Moai 享用。',
                        icon: 'fa-solid fa-monument',
                        images: [
                            'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d5/Makomanai_Takino_Cemetery_Moai.jpg/800px-Makomanai_Takino_Cemetery_Moai.jpg',
                            'https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/Hill_of_the_Buddha_August_2019.jpg/800px-Hill_of_the_Buddha_August_2019.jpg'
                        ],
                        currentImageIndex: 0,
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Hill of the Buddha")}',
                        details: { distance: '10分', transport: '車程', stay: '2小時' }
                    },
                    {
                        date: 23,
                        title: '慕尼黑聖誕市集',
                        location: '大通公園 2丁目',
                        time: '15:30',
                        category: 'Event',
                        desc: '感受濃厚的歐洲聖誕氛圍！逛逛德式木屋攤位，品嚐熱紅酒、烤杏仁，挑選精緻的聖誕飾品。',
                        icon: 'fa-solid fa-tree',
                        image: 'https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Sapporo Munich Christmas Market")}',
                        details: { distance: '市區', transport: '自駕回市區', stay: '自由' }
                    },
                    {
                        date: 23,
                        title: '晚餐：禪 (ZEN) 壽喜燒',
                        location: '南2條西1丁目',
                        time: '20:15',
                        category: 'Dinner',
                        desc: '預約席。享用高品質的和牛壽喜燒與涮涮鍋放題。地址：山口中央ビル B1F。',
                        icon: 'fa-solid fa-utensils',
                        image: 'https://images.unsplash.com/photo-1542353956-62024220c326?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Zen Sukiyaki Sapporo")}',
                        details: { distance: '步行', transport: '5-8分鐘', stay: '晚餐' }
                    },

                    // Day 24 (Christmas Eve)
                    {
                        date: 24,
                        title: '前往支笏湖 & 午餐',
                        location: '支笏湖畔',
                        time: '11:30',
                        category: 'Drive',
                        desc: '離開札幌，前往日本最北的不凍湖—支笏湖。在湖畔餐廳 (推薦 Log Bear) 享用午餐，欣賞湖光山色。',
                        icon: 'fa-solid fa-water',
                        image: 'https://images.unsplash.com/photo-1612255737525-4c0920b72a94?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Lake Shikotsu")}',
                        details: { distance: '45km', transport: '自駕 1h', stay: '2小時' }
                    },
                    {
                        date: 24,
                        title: '入住 翠山亭',
                        location: '支笏湖温泉',
                        time: '15:00',
                        category: 'Hotel',
                        desc: '入住「支笏湖第一寶亭留 翠山亭」。享受一泊二食的奢華溫泉體驗，度過寧靜浪漫的平安夜。',
                        icon: 'fa-solid fa-hot-tub-person',
                        image: 'https://cf.bstatic.com/xdata/images/hotel/max1024x768/336239563.jpg?k=2397c88e999c0087790885567789785089088788',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Shikotsuko Daiichi Hotel Suizantei")}',
                        details: { distance: '湖畔', transport: '步行', stay: '一泊二食' }
                    },

                    // Day 25 (Christmas Day)
                    {
                        date: 25,
                        title: '聖誕晨間溫泉 & 早餐',
                        location: '翠山亭',
                        time: '09:00',
                        category: 'Relax',
                        desc: '在支笏湖的寧靜中醒來，享受晨間溫泉與精緻的日式早餐，度過悠閒的聖誕早晨。',
                        icon: 'fa-solid fa-mug-hot',
                        image: 'https://images.unsplash.com/photo-1544473244-f6895e672d6a?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Shikotsuko Daiichi Hotel Suizantei")}',
                        details: { distance: '飯店內', transport: '放鬆', stay: '至退房' }
                    },
                    {
                        date: 25,
                        title: '入住 新札幌 Airbnb',
                        location: '厚別區 (新札幌)',
                        time: '15:00',
                        category: 'Stay',
                        desc: '前往位於新札幌的寬敞 Airbnb。這裡交通便利，適合家庭聚會。',
                        icon: 'fa-solid fa-house-chimney',
                        image: 'https://a0.muscache.com/im/pictures/miso/Hosting-32963798/original/fd9b9c75-a508-4672-87ec-2cf9bd5f3720.jpeg?im_w=720',
                        mapLink: 'https://www.airbnb.com.hk/rooms/32963798',
                        details: { distance: '40km', transport: '自駕 1h', stay: '過夜' }
                    },
                    {
                        date: 25,
                        title: '超市采購',
                        location: 'AEON 新札幌店',
                        time: '16:30',
                        category: 'Shopping',
                        desc: '前往附近的大型超市「AEON 新札幌店」採買聖誕晚餐食材。這裡食材種類豐富，非常適合準備大餐。',
                        icon: 'fa-solid fa-cart-shopping',
                        image: 'https://images.unsplash.com/photo-1578916171728-46686eac8d58?q=80&w=800',
                        mapLink: 'https://maps.google.com/maps?q=${encodeURIComponent("Aeon Shin-Sapporo")}',
                        suggestion: '推薦買北海道產牛排與海鮮！',
                        details: { distance: '5分', transport: '車/步行', stay: '1.5小時' }
                    },
                    
                ])

                const filteredItinerary = computed(() => itineraryData.value.filter(item => item.date === selectedDate.value))

                // --- Other Features (Expenses, Shopping with Image Upload) ---
                const savedExpenses = localStorage.getItem('trip_expenses')
                const expenses = ref(savedExpenses ? JSON.parse(savedExpenses) : [{ title: '機場星巴克', amount: 800, date: '12/20' }])
                const savedBudget = localStorage.getItem('trip_budget')
                const budgetAmount = ref(savedBudget ? JSON.parse(savedBudget) : 200000)
                const isEditingBudget = ref(false)
                const budgetInputRef = ref(null)
                
                const savedShopping = localStorage.getItem('trip_shopping')
                const shoppingList = ref(savedShopping ? JSON.parse(savedShopping) : [{ name: '白色戀人', checked: false }])
                const newItem = ref('')
                const newItemImage = ref(null) // New image state

                watch(expenses, (newVal) => localStorage.setItem('trip_expenses', JSON.stringify(newVal)), { deep: true })
                watch(budgetAmount, (newVal) => localStorage.setItem('trip_budget', JSON.stringify(newVal)))
                watch(shoppingList, (newVal) => localStorage.setItem('trip_shopping', JSON.stringify(newVal)), { deep: true })

                const newExpense = ref({ title: '', amount: '' })
                const addExpense = () => {
                    if(newExpense.value.title && newExpense.value.amount) {
                        expenses.value.unshift({ title: newExpense.value.title, amount: newExpense.value.amount, date: '12/' + selectedDate.value })
                        newExpense.value = { title: '', amount: '' }
                    }
                }
                const deleteExpense = (index) => { if(confirm('確定要刪除這筆支出嗎？')) expenses.value.splice(index, 1); }
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0))
                const remaining = computed(() => budgetAmount.value - totalExpense.value)
                const totalExpenseHkd = computed(() => (totalExpense.value * 0.052).toFixed(0))
                
                const editBudget = () => { isEditingBudget.value = true; nextTick(() => { if(budgetInputRef.value) budgetInputRef.value.focus() }) }
                const saveBudget = () => { isEditingBudget.value = false; if(budgetAmount.value < 0) budgetAmount.value = 0; }
                const getIcon = (title) => { if(title.includes('食') || title.includes('拉麵')) return '🍜'; return '💸'; }
                
                // --- Shopping Logic with Image ---
                const handleFileChange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => { newItemImage.value = e.target.result; };
                        reader.readAsDataURL(file);
                    }
                }
                
                const addItem = () => {
                    if(newItem.value) { 
                        shoppingList.value.push({ 
                            name: newItem.value, 
                            checked: false,
                            image: newItemImage.value 
                        }); 
                        newItem.value = '';
                        newItemImage.value = null;
                    }
                }
                const deleteShoppingItem = (index) => { if(confirm('確定要刪除這個項目嗎？')) shoppingList.value.splice(index, 1); }
                const imageError = (e) => { e.target.src = 'https://via.placeholder.com/600x400?text=No+Image'; }

                onMounted(() => {
                    const snowContainer = document.getElementById('snow-container');
                    const createSnowflake = () => {
                        const snowflake = document.createElement('div');
                        snowflake.classList.add('snowflake');
                        snowflake.innerHTML = Math.random() > 0.5 ? '❄' : '•';
                        snowflake.style.left = Math.random() * 100 + 'vw';
                        const size = Math.random() * 8 + 6; 
                        snowflake.style.fontSize = size + 'px';
                        snowflake.style.opacity = Math.random() * 0.5 + 0.3;
                        snowflake.style.animationDuration = (Math.random() * 10 + 15) + 's';
                        snowflake.style.animationDelay = Math.random() * 5 + 's';
                        snowContainer.appendChild(snowflake);
                        setTimeout(() => snowflake.remove(), 25000); 
                    };
                    for(let i=0; i<8; i++) setTimeout(createSnowflake, i * 500);
                    setInterval(createSnowflake, 800);
                })

                return {
                    activeTab, dates, selectedDate, hourlyWeather, filteredItinerary,
                    expenses, newExpense, addExpense, deleteExpense, totalExpense, getIcon,
                    budgetAmount, isEditingBudget, editBudget, saveBudget, budgetInputRef, remaining, totalExpenseHkd,
                    shoppingList, newItem, addItem, deleteShoppingItem, newItemImage, handleFileChange, tabTitles, imageError,
                    currentLocationName, weatherLoading,
                    lightboxState, openLightbox, closeLightbox, handleScroll,
                    currentMapUrl, savedLocations, updateMap
                }
            }
        }).mount('#app')
    </script>
</body>
</html>