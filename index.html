<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Hokkaido Christmas Trip 2025</title>
    
    <link rel="apple-touch-icon" href="https://i.meee.com.tw/m8KEd5j.jpg">
    <link rel="icon" type="image/jpeg" href="https://i.meee.com.tw/m8KEd5j.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        christmas: { red: '#E63946', dark: '#1D3557', light: '#F1FAEE', blue: '#457B9D', snow: '#A8DADC' }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        html, body { height: 100%; overflow: hidden; overscroll-behavior: none; background-color: #1D3557; }
        #app { height: 100dvh; width: 100%; display: flex; flex-direction: column; }
        .header-bg { background-image: url('https://images.microcms-assets.io/assets/14d13bd618dc45c7b684223c0ca9d033/6a65e76092c949d3aaa7fd8a5a2046af/pixta_85703873_M.jpg'); background-size: cover; background-position: center; }
        .header-blur { backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
        .snowflake { position: absolute; top: -20px; color: #fff; pointer-events: none; animation-name: fall; animation-timing-function: linear; animation-iteration-count: infinite; }
        @keyframes fall { 0% { opacity: 0; transform: translate(0, -20px) rotate(0deg); } 10% { opacity: 0.9; } 100% { opacity: 0.2; transform: translate(0, 110vh) rotate(180deg); } }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slider-dot { width: 6px; height: 6px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.4); transition: all 0.3s ease; }
        .slider-dot.active { background-color: white; width: 12px; border-radius: 4px; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #E63946; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="snow-container" class="fixed inset-0 pointer-events-none z-50"></div>

    <div id="app">
        <header class="relative shrink-0 z-20 overflow-hidden rounded-b-[2rem] shadow-xl flex flex-col justify-end transition-all duration-300 pt-[max(env(safe-area-inset-top),20px)] pb-4">
            <div class="absolute inset-0 header-bg"></div>
            <div class="absolute inset-0 bg-christmas-dark/40 header-blur"></div>
            <div class="relative z-10 px-6 mt-2">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-christmas-snow text-[10px] font-bold tracking-wider mb-0.5 opacity-90">HOKKAIDO 2025</p>
                        <h1 class="text-2xl font-bold font-serif text-white shadow-black drop-shadow-md">Christmas Trip <i class="fa-solid fa-snowflake text-christmas-snow animate-pulse text-sm"></i></h1>
                    </div>
                    <div class="w-14 h-14 rounded-full bg-yellow-400 overflow-hidden border-2 border-white shadow-sm mb-1">
                        <img src="https://i.meee.com.tw/kYUJZ1x.png" alt="Profile" class="w-full h-full object-cover">
                    </div>
                </div>
                <div v-if="activeTab === 'itinerary'" class="flex space-x-3 overflow-x-auto no-scrollbar pb-1 px-1">
                    <div v-for="(date, index) in dates" :key="index" @click="selectedDate = date.day" :class="['flex-shrink-0 w-20 h-20 rounded-xl flex flex-col items-center justify-center transition-all cursor-pointer border', selectedDate === date.day ? 'bg-christmas-red text-white border-christmas-red transform scale-105 shadow-md' : 'bg-white/10 text-white border-white/20 backdrop-blur-sm']">
                        <span class="text-[10px] opacity-80">{{ date.weekday }}</span><span class="text-xl font-bold">{{ date.day }}</span>
                    </div>
                </div>
                <div v-else class="mt-1 pb-2"><h2 class="text-lg font-medium text-white opacity-90">{{ tabTitles[activeTab] }}</h2></div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar bg-[#f3f4f6] relative z-10 w-full">
            <div class="pt-6 px-4 pb-6">
                <transition name="fade" mode="out-in">
                    
                    <div v-if="activeTab === 'itinerary'" key="itinerary">
                        <div class="flex justify-between items-end mb-4 px-2">
                            <div><h3 class="text-xl font-bold text-gray-800">{{ currentLocationName }} <span class="text-sm font-normal text-gray-500 font-serif ml-2">Dec {{ selectedDate }}</span></h3><p class="text-[10px] text-christmas-blue/70 mt-1"><i class="fa-solid fa-satellite-dish mr-1"></i>Open-Meteo 當地實時天氣</p></div>
                        </div>
                        <div class="relative min-h-[100px]">
                            <div v-if="weatherLoading" class="absolute inset-0 flex items-center justify-center bg-gray-50/50 z-10 rounded-xl"><div class="loader"></div></div>
                            <div class="flex space-x-3 overflow-x-auto no-scrollbar mb-6 py-2 px-1">
                                <div v-for="(h, i) in hourlyWeather" :key="i" :class="['flex-shrink-0 w-16 h-24 rounded-xl shadow-sm flex flex-col items-center justify-center border transition-all duration-500', i === 0 ? 'bg-blue-50 border-christmas-blue/30 scale-105' : 'bg-white border-transparent']">
                                    <span class="text-[10px] text-gray-400 mb-1">{{ h.time }}</span><i :class="[h.icon, i === 0 ? 'text-christmas-blue' : 'text-yellow-500', 'my-2 text-xl']"></i><span class="text-sm font-bold text-gray-700">{{ h.temp }}°</span><span v-if="i === 0" class="text-[9px] text-christmas-blue font-bold mt-1 bg-blue-100 px-1.5 rounded-full">NOW</span>
                                </div>
                            </div>
                        </div>
                        <div class="relative pl-6 space-y-8 ml-2">
                            <div class="absolute left-[23px] top-2 bottom-0 w-[3px] bg-gradient-to-b from-[#d9888e] via-[#d4af37] to-[#76a5af] shadow-[0_0_8px_rgba(212,175,55,0.4)] rounded-full"></div>
                            <div v-if="filteredItinerary.length === 0" class="py-10 text-center text-gray-400"><i class="fa-regular fa-calendar-xmark text-3xl mb-2 opacity-50"></i><p class="text-xs">這一天目前沒有安排行程</p></div>
                            <div v-for="(item, idx) in filteredItinerary" :key="idx" class="relative">
                                <div class="absolute -left-[8px] top-6 w-4 h-4 rounded-full bg-gray-300 border-2 border-white shadow-sm z-10"></div>
                                <div class="bg-white rounded-2xl shadow-sm overflow-hidden ml-4 transform transition hover:scale-[1.01] duration-200">
                                    <div class="h-44 w-full relative group bg-gray-200">
                                        <div v-if="item.images && item.images.length > 1" class="w-full h-full relative">
                                            <div class="flex overflow-x-auto snap-x snap-mandatory w-full h-full no-scrollbar" @scroll="(e) => handleScroll(e, item)">
                                                <img v-for="(img, imgIdx) in item.images" :key="imgIdx" :src="img" @click="openLightbox(img)" class="w-full h-full object-cover flex-shrink-0 snap-center cursor-pointer">
                                            </div>
                                            <div class="absolute bottom-3 left-0 right-0 flex justify-center space-x-1.5 z-20 pointer-events-none"><div v-for="(img, index) in item.images" :key="index" :class="['slider-dot', index === item.currentImageIndex ? 'active' : '']"></div></div>
                                        </div>
                                        <div v-else-if="item.image" class="w-full h-full relative"><img :src="item.image" @click="openLightbox(item.image)" class="w-full h-full object-cover cursor-pointer" referrerpolicy="no-referrer" @error="imageError"></div>
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/30 pointer-events-none"></div>
                                        <div class="absolute top-4 left-4 text-white/90 text-xs font-medium flex items-center shadow-black drop-shadow-sm pointer-events-none"><i class="fa-solid fa-location-dot mr-1.5"></i> {{ item.location }}</div>
                                        <a :href="item.mapLink" target="_blank" class="absolute top-4 right-4 w-8 h-8 bg-white/20 text-white rounded-full flex items-center justify-center backdrop-blur-md border border-white/30 hover:bg-white hover:text-christmas-blue transition-colors z-30 pointer-events-auto"><i class="fa-solid fa-location-arrow text-xs"></i></a>
                                        <div class="absolute bottom-4 left-4 text-white pointer-events-none"><h3 class="text-xl font-bold tracking-wide shadow-black drop-shadow-md">{{ item.title }}</h3></div>
                                        <div class="absolute bottom-4 right-4 bg-black/40 backdrop-blur-md text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center border border-white/20 pointer-events-none"><i class="fa-regular fa-clock mr-1.5"></i> {{ item.time }}</div>
                                    </div>
                                    <div v-if="item.details" class="flex border-b border-gray-100 py-4">
                                        <div class="flex-1 text-center border-r border-gray-100 px-2"><div class="text-[10px] text-christmas-blue font-bold mb-1 tracking-wider">距離</div><div class="text-xs text-gray-600 font-bold whitespace-pre-line leading-tight">{{ item.details.distance }}</div></div>
                                        <div class="flex-1 text-center border-r border-gray-100 px-2"><div class="text-[10px] text-christmas-blue font-bold mb-1 tracking-wider">交通</div><div class="text-xs text-gray-600 font-bold leading-tight">{{ item.details.transport }}</div></div>
                                        <div class="flex-1 text-center px-2"><div class="text-[10px] text-christmas-blue font-bold mb-1 tracking-wider">停留</div><div class="text-xs text-gray-600 font-bold leading-tight">{{ item.details.stay }}</div></div>
                                    </div>
                                    <div v-if="item.parking" class="bg-gray-50 border-b border-gray-100 px-4 py-2 flex items-start gap-2">
                                        <i class="fa-solid fa-square-parking text-christmas-blue mt-0.5 text-xs"></i><div class="text-xs text-gray-600 font-medium">{{ item.parking }}</div>
                                    </div>
                                    <div v-if="item.suggestion" class="mx-4 mt-4 bg-yellow-50 rounded-lg p-3 flex items-center text-yellow-700 border border-yellow-100/50"><i class="fa-regular fa-bell mr-3 text-yellow-600"></i><span class="text-xs font-bold">{{ item.suggestion }}</span></div>
                                    <div class="p-4 text-sm text-gray-500 leading-relaxed text-justify">{{ item.desc }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="h-10 text-center text-gray-300 text-xs mt-8">- End of Day -</div>
                    </div>

                    <div v-else-if="activeTab === 'map'" key="map" class="h-full flex flex-col">
                        <div class="bg-white p-2 rounded-xl shadow-sm mb-4 relative">
                            <iframe :src="currentMapUrl" width="100%" height="400" style="border:0; border-radius: 12px;" allowfullscreen="" loading="lazy"></iframe>
                            <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-gray-600 shadow-sm border"><i class="fa-solid fa-map-pin text-christmas-red mr-1"></i> 點擊下方列表導航</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1 overflow-y-auto">
                            <ul class="space-y-2">
                                <li v-for="(loc, idx) in savedLocations" :key="idx" @click="updateMap(loc)" class="flex items-center p-3 rounded-lg hover:bg-gray-50 transition cursor-pointer group border border-transparent hover:border-gray-100">
                                    <div :class="['w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm transition-colors', loc.active ? 'bg-christmas-red text-white' : 'bg-gray-100 text-gray-500 group-hover:bg-white group-hover:text-christmas-red group-hover:shadow-sm']"><i :class="loc.icon"></i></div>
                                    <div class="flex-1"><div :class="['font-bold text-sm transition-colors', loc.active ? 'text-christmas-red' : 'text-gray-700']">{{ loc.name }}</div><div class="text-[10px] text-gray-400">{{ loc.desc }}</div></div>
                                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs group-hover:text-christmas-red group-hover:translate-x-1 transition-all"></i>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div v-else-if="activeTab === 'budget'" key="budget">
                         <div class="bg-gradient-to-r from-christmas-blue to-christmas-dark text-white p-5 rounded-2xl shadow-lg mb-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 rounded-full bg-white/10 blur-xl"></div>
                            <div class="flex justify-between items-start mb-1 relative z-10"><p class="text-sm opacity-80">Total Expenses</p><span class="bg-white/20 px-2 py-0.5 rounded text-[10px] backdrop-blur-sm">≈ HKD ${{ totalExpenseHkd.toLocaleString() }}</span></div>
                            <h2 class="text-4xl font-bold relative z-10 mb-4 tracking-tight">¥ {{ totalExpense.toLocaleString() }}</h2>
                            <div class="flex gap-2 relative z-10">
                                <div class="bg-white/20 rounded-lg text-xs backdrop-blur-md flex items-center transition-all duration-200 border border-white/10 hover:bg-white/30 h-8">
                                    <div v-if="!isEditingBudget" @click="editBudget" class="px-3 h-full flex items-center cursor-pointer select-none"><span class="opacity-70 mr-1">預算:</span> <span class="font-bold">¥{{ budgetAmount.toLocaleString() }}</span><i class="fa-solid fa-pen ml-2 text-[10px] opacity-60"></i></div>
                                    <div v-else class="px-1 h-full flex items-center"><span class="pl-2 opacity-70 mr-1">¥</span><input ref="budgetInputRef" v-model.number="budgetAmount" @blur="saveBudget" @keyup.enter="saveBudget" type="number" class="w-20 bg-transparent text-white font-bold outline-none placeholder-white/50"></div>
                                </div>
                                <div class="bg-white/20 px-3 h-8 flex items-center rounded-lg text-xs backdrop-blur-md border border-white/10"><span class="opacity-70 mr-1">剩餘:</span> <span :class="['font-bold', remaining < 0 ? 'text-red-300' : 'text-white']">¥{{ remaining.toLocaleString() }}</span></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                            <h3 class="font-bold text-gray-700 mb-3 text-sm">新增支出</h3>
                            <div class="flex gap-2 mb-2">
                                <input v-model="newExpense.title" type="text" placeholder="項目" class="flex-1 bg-gray-100 p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-christmas-blue min-w-0">
                                <input v-model.number="newExpense.amount" type="number" placeholder="¥" class="w-28 bg-gray-100 p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-christmas-blue text-center">
                            </div>
                            <button @click="addExpense" class="w-full bg-christmas-red text-white py-2 rounded-lg font-bold text-sm shadow-md active:scale-95 transition">新增</button>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(exp, idx) in expenses" :key="idx" :class="[getExpenseBg(exp.date), 'p-3 rounded-xl shadow-sm flex justify-between items-center group mb-2 border border-black/5']">
                                <div class="flex items-center"><div class="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center mr-3 text-lg">{{ getIcon(exp.title) }}</div><div><div class="font-bold text-gray-800">{{ exp.title }}</div><div class="text-xs text-gray-500 font-mono">{{ exp.date }}</div></div></div>
                                <div class="flex items-center gap-3"><div class="font-bold text-gray-800">-¥{{ exp.amount.toLocaleString() }}</div><button @click="deleteExpense(idx)" class="w-6 h-6 rounded-full bg-white/50 text-gray-400 hover:bg-red-100 hover:text-red-500 flex items-center justify-center transition"><i class="fa-solid fa-trash-can text-xs"></i></button></div>
                            </div>
                            <div v-if="expenses.length === 0" class="text-center text-gray-400 text-xs py-4">目前沒有支出紀錄</div>
                        </div>
                    </div>

                    <div v-else-if="activeTab === 'shopping'" key="shopping">
                        <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                            <div v-if="newItemImage" class="mb-2 relative w-16 h-16 group">
                                <img :src="newItemImage" class="w-full h-full object-cover rounded-lg border shadow-sm">
                                <button @click="clearImage" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] shadow">×</button>
                            </div>
                            <div class="flex gap-3 h-12">
                                <button @click="$refs.fileInput.click()" class="bg-gray-100 text-gray-500 w-14 h-full rounded-lg hover:bg-gray-200 transition flex items-center justify-center">
                                    <i v-if="!isCompressing" class="fa-solid fa-camera"></i>
                                    <div v-else class="loader border-gray-300 border-t-christmas-blue w-4 h-4"></div>
                                </button>
                                <input type="file" ref="fileInput" @change="handleFileChange" accept="image/*" class="hidden">
                                <input v-model="newItem" @keyup.enter="addItem" type="text" placeholder="想買什麼？" class="flex-1 h-full bg-gray-100 px-3 rounded-lg outline-none focus:ring-2 focus:ring-christmas-blue text-sm min-w-0">
                                <button @click="addItem" class="bg-christmas-dark text-white w-14 h-full rounded-lg hover:bg-christmas-blue transition flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div v-for="(item, idx) in shoppingList" :key="idx" :class="['p-4 rounded-xl shadow-sm transition-all relative overflow-hidden group border', item.checked ? 'bg-gray-200 border-transparent' : 'bg-white border-transparent']">
                                <div v-if="item.checked" class="absolute inset-0 flex items-center justify-center bg-black/10 z-10 pointer-events-none"><i class="fa-solid fa-check text-4xl text-green-500 opacity-50"></i></div>
                                <div class="flex justify-between items-start mb-2 relative z-20">
                                    <div v-if="item.image" class="w-10 h-10 rounded-lg overflow-hidden border cursor-pointer" @click.stop="openLightbox(item.image)"><img :src="item.image" class="w-full h-full object-cover"></div>
                                    <i v-else class="fa-solid fa-gift text-christmas-red text-xl"></i>
                                    <div @click.stop="item.checked = !item.checked" :class="['w-6 h-6 rounded-full border-2 flex items-center justify-center cursor-pointer transition-colors', item.checked ? 'border-green-500 bg-green-500' : 'border-gray-300 hover:border-green-400']"><i v-if="item.checked" class="fa-solid fa-check text-white text-xs"></i></div>
                                </div>
                                <button @click.stop="deleteShoppingItem(idx)" class="absolute top-2 right-10 w-6 h-6 rounded-full bg-white/50 text-gray-400 hover:bg-red-500 hover:text-white flex items-center justify-center z-20 transition shadow-sm"><i class="fa-solid fa-trash-can text-[10px]"></i></button>
                                <h4 :class="['font-bold mt-2 truncate', item.checked ? 'text-gray-500 line-through' : 'text-gray-800']" @click="item.checked = !item.checked">{{ item.name }}</h4>
                                <p class="text-xs text-gray-400">必買清單</p>
                            </div>
                        </div>
                        <div v-if="shoppingList.length === 0" class="text-center text-gray-400 text-xs py-10">清單是空的，快去加點東西！</div>
                    </div>
                </transition>
            </div>
        </main>

        <div class="shrink-0 bg-[#f3f4f6] z-20 relative">
            <nav class="bg-white w-full px-2 pt-3 pb-[calc(10px+env(safe-area-inset-bottom))] rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.05)] flex justify-around items-center">
                <button @click="activeTab = 'itinerary'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'itinerary' ? 'text-christmas-red' : 'text-gray-400']"><i class="fa-solid fa-calendar-days text-lg"></i><span class="text-[10px] font-bold">行程</span></button>
                <button @click="activeTab = 'map'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'map' ? 'text-christmas-red' : 'text-gray-400']"><i class="fa-solid fa-map-location-dot text-lg"></i><span class="text-[10px] font-bold">地圖</span></button>
                <button @click="activeTab = 'budget'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'budget' ? 'text-christmas-red' : 'text-gray-400']"><i class="fa-solid fa-wallet text-lg"></i><span class="text-[10px] font-bold">記帳</span></button>
                <button @click="activeTab = 'shopping'" :class="['flex flex-1 flex-col items-center space-y-1 transition py-2', activeTab === 'shopping' ? 'text-christmas-red' : 'text-gray-400']"><i class="fa-solid fa-bag-shopping text-lg"></i><span class="text-[10px] font-bold">購物</span></button>
            </nav>
        </div>

        <transition name="fade">
            <div v-if="lightboxState.show" class="fixed inset-0 z-[10000] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm" @click="closeLightbox">
                <div class="relative w-full max-w-lg">
                    <img :src="lightboxState.image" class="w-full h-auto rounded-lg shadow-2xl">
                    <button class="absolute -top-12 right-0 text-white bg-white/20 rounded-full w-10 h-10 flex items-center justify-center" @click.stop="closeLightbox"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, nextTick, reactive } = Vue

        createApp({
            setup() {
                const activeTab = ref('itinerary');
                const selectedDate = ref(20);
                const weatherLoading = ref(false);
                
                // DATA
                const tabTitles = { 'itinerary': '行程表', 'map': '探索地圖', 'budget': '旅行記帳', 'shopping': '購物清單' };
                const dates = [
                    { day: 20, weekday: '週六' }, { day: 21, weekday: '週日' }, { day: 22, weekday: '週一' }, 
                    { day: 23, weekday: '週二' }, { day: 24, weekday: '週三' }, { day: 25, weekday: '週四' }, 
                    { day: 26, weekday: '週五' }, { day: 27, weekday: '週六' }, { day: 28, weekday: '週日' },
                    { day: 29, weekday: '週一' }, { day: 30, weekday: '週二' }, { day: 31, weekday: '週三' }
                ];

                // WEATHER & LOCATION
                const hourlyWeather = ref([]);
                const getLocationByDate = (date) => {
                    if (date === 20) return { lat: 35.5494, lon: 139.7798, name: '東京轉機 (Tokyo)' };
                    if (date === 21) return { lat: 42.5937, lon: 140.8246, name: '洞爺湖 (Lake Toya)' };
                    if (date >= 22 && date <= 23) return { lat: 43.0618, lon: 141.3545, name: '札幌 (Sapporo)' };
                    if (date === 24) return { lat: 42.7688, lon: 141.4047, name: '支笏湖 (Lake Shikotsu)' };
                    if (date === 25) return { lat: 43.0400, lon: 141.4700, name: '新札幌 (Shin-Sapporo)' };
                    if (date === 26) return { lat: 43.1907, lon: 140.9947, name: '小樽 (Otaru)' };
                    if (date === 27) return { lat: 43.5859, lon: 142.4746, name: '美瑛 (Biei)' };
                    if (date === 28) return { lat: 43.0618, lon: 141.3545, name: '札幌 (Sapporo)' };
                    if (date === 29) return { lat: 42.8273, lon: 141.6525, name: '千歲 (Chitose)' };
                    if (date >= 30) return { lat: 35.6895, lon: 139.6917, name: '東京 (Tokyo)' };
                    return { lat: 43.0618, lon: 141.3545, name: '北海道 (Hokkaido)' };
                }
                const currentLocationName = computed(() => getLocationByDate(selectedDate.value).name);
                const getWeatherIcon = (code) => {
                    if (code <= 1) return 'fa-solid fa-sun'; if (code <= 3) return 'fa-solid fa-cloud-sun'; if (code <= 48) return 'fa-solid fa-smog';
                    if (code <= 67) return 'fa-solid fa-cloud-rain'; if (code <= 77) return 'fa-regular fa-snowflake'; if (code <= 82) return 'fa-solid fa-cloud-showers-heavy';
                    if (code <= 86) return 'fa-solid fa-snowflake'; if (code <= 99) return 'fa-solid fa-bolt'; return 'fa-solid fa-cloud';
                }
                const fetchWeather = async () => {
                    weatherLoading.value = true;
                    try {
                        const loc = getLocationByDate(selectedDate.value);
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&hourly=temperature_2m,weathercode&timezone=Asia%2FTokyo&forecast_days=2`);
                        const data = await response.json();
                        const currentHour = new Date().getHours();
                        const mappedData = [];
                        for(let i = 0; i < 24; i++) {
                            const dataIndex = currentHour + i;
                            if (data.hourly.temperature_2m[dataIndex] !== undefined) {
                                let displayHour = (currentHour + i) % 24;
                                let timeStr = displayHour < 10 ? `0${displayHour}:00` : `${displayHour}:00`;
                                mappedData.push({ time: timeStr, temp: Math.round(data.hourly.temperature_2m[dataIndex]), icon: getWeatherIcon(data.hourly.weathercode[dataIndex]) });
                            }
                        }
                        hourlyWeather.value = mappedData;
                    } catch (e) { hourlyWeather.value = [{ time: 'Error', temp: '--', icon: 'fa-solid fa-triangle-exclamation' }]; } finally { weatherLoading.value = false; }
                }
                watch(selectedDate, () => { fetchWeather(); }, { immediate: true });

                // MAP & ITINERARY
                const defaultMapUrl = 'https://maps.google.com/maps?q=Hokkaido&z=6&output=embed';
                const currentMapUrl = ref(defaultMapUrl);
                const savedLocations = ref([
                    // Day 20: 東京抵達
                    { name: 'KEIKYU EX INN', query: 'KEIKYU EX INN Haneda Innovation City', icon: 'fa-solid fa-hotel', desc: 'D20/30 住宿：天空橋站旁', active: false },
                    
                    // Day 21: 千歲 -> 登別 -> 洞爺湖
                    { name: 'Budget 租車', query: 'Budget Car Rental New Chitose Airport', icon: 'fa-solid fa-car', desc: 'D21 取車 / D30 還車', active: false },
                    { name: '湯咖哩 SAMURAI', query: 'Rojiura Curry SAMURAI Chitose', icon: 'fa-solid fa-utensils', desc: 'D21 午餐：千歲美味湯咖哩', active: false },
                    { name: '登別地獄谷', query: 'Noboribetsu Jigokudani', icon: 'fa-solid fa-volcano', desc: 'D21 景點：火山地熱景觀', active: false },
                    { name: 'Hotel Cocoa', query: 'Hotel Cocoa Toyako', icon: 'fa-solid fa-hotel', desc: 'D21 住宿：洞爺湖畔', active: false },
                    
                    // Day 22: 洞爺湖 -> 札幌
                    { name: '洞爺湖', query: 'Lake Toya', icon: 'fa-solid fa-water', desc: 'D22 景點：晨間湖畔散策', active: false },
                    { name: '狸小路商店街', query: 'Tanukikoji Shopping Street', icon: 'fa-solid fa-bag-shopping', desc: 'D22 逛街：藥妝與唐吉訶德', active: false },
                    { name: '札幌民宿', query: 'Sapporo', icon: 'fa-solid fa-house-user', desc: 'D22-23 住宿：札幌市區', active: false },
                    
                    // Day 23: 瀧野公園 -> 聖誕市集
                    { name: '國營瀧野鈴蘭公園', query: 'Takino Suzuran Hillside Park', icon: 'fa-solid fa-snowflake', desc: 'D23 活動：玩雪、輪胎滑雪', active: false },
                    { name: '頭大佛殿', query: 'Hill of the Buddha', icon: 'fa-solid fa-monument', desc: 'D23 景點：安藤忠雄設計', active: false },
                    { name: '慕尼黑聖誕市集', query: 'Sapporo Odori Park', icon: 'fa-solid fa-tree', desc: 'D23 活動：大通公園聖誕燈飾', active: false },
                    { name: '禪 (ZEN) 壽喜燒', query: 'Zen Sukiyaki Sapporo', icon: 'fa-solid fa-utensils', desc: 'D23 晚餐：和牛壽喜燒吃到飽', active: false },
                    
                    // Day 24: 支笏湖
                    { name: '支笏湖', query: 'Lake Shikotsu', icon: 'fa-solid fa-water', desc: 'D24 景點：日本最北不凍湖', active: false },
                    { name: '翠山亭', query: 'Shikotsuko Daiichi Hotel Suizantei', icon: 'fa-solid fa-hot-tub-person', desc: 'D24 住宿：高級溫泉旅館', active: false },
                    
                    // Day 25: 新札幌
                    { name: 'AEON 新札幌', query: 'Aeon Shin-Sapporo', icon: 'fa-solid fa-cart-shopping', desc: 'D25 購物：採買聖誕大餐食材', active: false },
                    { name: '新札幌民宿', query: 'Shin-Sapporo Station', icon: 'fa-solid fa-house-chimney', desc: 'D25-28 住宿：厚別區', active: false },
                    
                    // Day 26: 小樽一日遊
                    { name: '小樽運河', query: 'Otaru Canal', icon: 'fa-solid fa-camera-retro', desc: 'D26 景點：浪漫運河散策', active: false },
                    { name: '政壽司 (本店)', query: 'Otaru Masazushi Honten', icon: 'fa-solid fa-utensils', desc: 'D26 午餐：小樽壽司通', active: false },
                    { name: 'LeTAO 本店', query: 'LeTAO Main Store Otaru', icon: 'fa-solid fa-cookie', desc: 'D26 甜點：堺町通逛街', active: false },
                    { name: '小樽天狗山', query: 'Otaru Tenguyama Ropeway', icon: 'fa-solid fa-mountain', desc: 'D26 景點：北海道三大夜景', active: false },
                    
                    // Day 27: 美瑛白金溫泉
                    { name: '白鬚瀑布', query: 'Shirahige Waterfall', icon: 'fa-solid fa-water', desc: 'D27 景點：藍色河川與瀑布', active: false },
                    { name: '白金不動瀑布', query: 'Shirogane Fudo Waterfall', icon: 'fa-solid fa-person-hiking', desc: 'D27 景點：森林雪徑徒步', active: false },
                    { name: 'Daimaru (大丸)', query: 'Family Restaurant Daimaru Biei', icon: 'fa-solid fa-utensils', desc: 'D27 午餐：美瑛咖哩烏龍麵', active: false },
                    { name: '肯與瑪麗之樹', query: 'Ken and Mary Tree', icon: 'fa-solid fa-tree', desc: 'D27 景點：拼布之路', active: false },
                    { name: '美瑛車站', query: 'Biei Station', icon: 'fa-solid fa-store', desc: 'D27 散策：小鎮閒逛', active: false },

                    // Day 28: 札幌市區漫遊
                    { name: '羊之丘展望台', query: 'Hitsujigaoka Observation Hill', icon: 'fa-solid fa-binoculars', desc: 'D28 景點：克拉克博士像', active: false },
                    { name: 'Suage+ 湯咖哩', query: 'Suage+ Sapporo', icon: 'fa-solid fa-utensils', desc: 'D28 午餐：人氣湯咖哩', active: false },
                    { name: '北海道神宮', query: 'Hokkaido Shrine', icon: 'fa-solid fa-torii-gate', desc: 'D28 景點：雪中參拜', active: false },
                    { name: '白色戀人公園', query: 'Shiroi Koibito Park', icon: 'fa-solid fa-cookie-bite', desc: 'D28 景點：工廠參觀與點燈', active: false },
                    { name: '迴轉壽司 Toriton', query: 'Toriton Toyohira', icon: 'fa-solid fa-fish', desc: 'D28 晚餐：人氣迴轉壽司', active: false },
                    
                    // Day 29: 購物 & 千歲
                    { name: '三井 Outlet', query: 'Mitsui Outlet Park Sapporo Kitahiroshima', icon: 'fa-solid fa-bag-shopping', desc: 'D29 購物：北廣島 Outlet', active: false },
                    { name: 'AEON 千歲', query: 'Aeon Chitose', icon: 'fa-solid fa-cart-shopping', desc: 'D29 購物：最後採買', active: false },
                    { name: '千歲民宿', query: 'Chitose Station', icon: 'fa-solid fa-bed', desc: 'D29 住宿：近機場', active: false },

                    // Day 30: 東京快閃
                    { name: '東京銀座', query: 'Ginza Station', icon: 'fa-solid fa-city', desc: 'D30 購物：步行者天國', active: false }
                ]);
                const updateMap = (location) => {
                    savedLocations.value.forEach(l => l.active = false); location.active = true;
                    // UPDATED TO REAL GOOGLE MAPS LINK
                    currentMapUrl.value = `https://maps.google.com/maps?q=${encodeURIComponent(location.query)}&t=&z=13&ie=UTF8&iwloc=&output=embed`; 
                };

                const itineraryData = ref([
                    {
                        date: 20,
                        title: '廣州往東京 (NH924)',
                        location: '廣州白雲國際機場 T1',
                        time: '15:05',
                        category: 'Flight',
                        desc: '航班 : ANA NH924。預訂參考編號 : XK6OCG。機型舒適，飛行時間 3小時55分。',
                        icon: 'fa-solid fa-plane-departure',
                        image: 'https://dayooimg.dayoo.com/www/202402/06/54628485_bfb1e75b-3a34-491c-befd-52c4a4a38c11.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Guangzhou+Baiyun+International+Airport+Terminal+1',
                        suggestion: '建議到達時間 : 12:35',
                        details: { distance: '飛行距離\n2,900 km', transport: '3小時55分', stay: '航程' }
                    },
                    {
                        date: 20,
                        title: '抵達東京 (羽田機場)',
                        location: '羽田機場 T2',
                        time: '20:00',
                        category: 'Arrival',
                        desc: '抵達羽田機場第2航廈 (T2)。辦理入境手續，感受日本冬日氣息。',
                        icon: 'fa-solid fa-location-dot',
                        image: 'https://lh7-us.googleusercontent.com/WjfbIrlhtJ-Z7HwnV6h7fXSfhk0ZOgfZG-fI7yJ4MqxAPtXYUoj6L3RUnAxWS6rqfjNEEgscg0NPRJutSOZS3LW_50-XEycs8gIHwrEafiIMImvLvbYBtTo5HaJtXBii3Nxro_y-sYXR9aGcCkeHdUU',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Haneda+Airport+Terminal+2',
                        details: { distance: '機場內', transport: '步行', stay: '1小時' }
                    },
                    {
                        date: 20,
                        title: '入住 KEIKYU EX INN',
                        location: 'KEIKYU EX INN',
                        time: '21:30',
                        category: 'Hotel',
                        desc: '地址：1-1-4 Haneda Airport。位於天空橋站 HICity 出口步行2分鐘。備有大浴場可放鬆身心。',
                        icon: 'fa-solid fa-bed',
                        images: [
                            'https://pix8.agoda.net/hotelImages/16791240/803978242/bc74de46d2361212f60426dc71338600.jpg?ce=0&s=1024x',
                            'https://pix8.agoda.net/hotelImages/16791240/803978242/b69c0182316827d1c477e36427be07c3.jpg?ce=0&s=1024x',
                            'https://pix8.agoda.net/hotelImages/16791240/803978242/1bd9a4da30ccb7860ad744bfa3f47ae3.jpg?ce=0&s=1024x'
                        ],
                        currentImageIndex: 0,
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=KEIKYU+EX+INN+Haneda+Innovation+City',
                        details: { distance: '一站距離', transport: '電車/接駁', stay: '過夜' }
                    },
                    {
                        date: 21,
                        title: '飛往札幌 (新千歲)',
                        location: '羽田機場 -> 新千歲',
                        time: '08:00',
                        category: 'Flight',
                        desc: '搭乘早班機前往北海道新千歲機場，準備開始自駕之旅！',
                        icon: 'fa-solid fa-plane',
                        image: 'https://hk.wamazing.com/media/wp-content/uploads/sites/5/2019/09/shinchitoseairporttaxfree_pixta_94252250_M-853x569.jpg.webp',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=New+Chitose+Airport',
                        suggestion: '建議到達時間 : 06:30 (需於 06:15 從 KEIKYU EX INN 出發)',
                        details: { distance: '820km', transport: '1h 30m', stay: '航程' }
                    },
                    {
                        date: 21,
                        title: 'Budget 租車取車',
                        location: '新千歲機場店',
                        time: '10:00',
                        category: 'Car Rental',
                        desc: '前往 Budget 櫃檯辦理取車手續。檢查車況、安裝雪胎，準備出發！',
                        icon: 'fa-solid fa-car',
                        image: 'https://www.budgetrentacar.co.jp/images/sys/shop/main_0700_1.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Budget+Car+Rental+New+Chitose+Airport',
                        details: { distance: '機場接駁', transport: '接駁車', stay: '30分' }
                    },
                    {
                        date: 21,
                        title: '午餐：北海道湯咖哩',
                        location: '千歲市區 / 機場',
                        time: '11:30',
                        category: 'Lunch',
                        desc: '抵達北海道的第一餐，當然要吃熱騰騰的湯咖哩暖胃！推薦嘗試 Rojiura Curry SAMURAI 或 Lavi。',
                        icon: 'fa-solid fa-utensils',
                        image: 'https://bento.com/rp/800/800-kagu-samurai.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Rojiura+Curry+SAMURAI+Chitose',
                        parking: '店鋪專用停車場 (免費)',
                        details: { distance: '市區內', transport: '自駕', stay: '1.5小時' }
                    },
                    {
                        date: 21,
                        title: '登別地獄谷',
                        location: '登別溫泉',
                        time: '14:00',
                        category: 'Sightseeing',
                        desc: '觀賞火山爆發後形成的火山口遺跡，煙霧繚繞，景色壯觀。空氣中瀰漫著濃濃的硫磺味。',
                        icon: 'fa-solid fa-volcano',
                        image: 'https://noboribetsu-spa.jp/tw/wp-content/uploads/sites/4/2020/12/spot0034-2.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Noboribetsu+Jigokudani',
                        parking: '地獄谷停車場 (500日圓/次)',
                        details: { distance: '60km', transport: '自駕 1h', stay: '1.5小時' }
                    },
                    {
                        date: 21,
                        title: '入住 Hotel Cocoa',
                        location: '洞爺湖',
                        time: '18:00',
                        category: 'Hotel',
                        desc: '抵達洞爺湖畔的 Hotel Cocoa。享受湖景與舒適的住宿環境，放鬆一天的疲憊。',
                        icon: 'fa-solid fa-hotel',
                        images: [
                            'https://q-xx.bstatic.com/xdata/images/hotel/840x460/445146130.jpg?k=f502e84c5929f5529ae905690d6b97012de0fff071b942fd1301ab4aa008b541&o=&s=1024x',
                            'https://pix8.agoda.net/hotelImages/26079610/410029220/fd0b49e14e153112c980fa9fc78aba7f.jpg?ce=2&s=1024x',
                            'https://pix8.agoda.net/hotelImages/26079610/410029220/1dbe30d5b439f5476c1881a794cc5aea.jpg?ce=2&s=1024x'
                        ],
                        currentImageIndex: 0,
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Hotel+Cocoa+Toyako',
                        parking: '飯店專用停車場 (免費)',
                        details: { distance: '50km', transport: '自駕 1h', stay: '過夜' }
                    },
                    {
                        date: 22,
                        title: '洞爺湖晨間散步',
                        location: '洞爺湖畔',
                        time: '09:30',
                        category: 'Sightseeing',
                        desc: '早晨在湖邊漫步，欣賞羊蹄山的倒影。推薦前往 Lake Hill Farm 品嚐新鮮的義式冰淇淋。',
                        icon: 'fa-solid fa-camera',
                        image: 'https://hk.wamazing.com/media/wp-content/uploads/sites/5/2019/05/touyakoonsen_pixta_77536008_M.jpg.webp',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Lake+Hill+Farm',
                        parking: 'Lake Hill Farm 停車場 (免費)',
                        details: { distance: '周邊', transport: '自駕', stay: '2小時' }
                    },
                    {
                        date: 22,
                        title: '前往札幌 & 午餐',
                        location: '迴轉壽司 Toriton',
                        time: '12:00',
                        category: 'Drive',
                        desc: '北海道當地人氣第一的迴轉壽司！食材新鮮、份量大。推薦：生干貝、大牡丹蝦。',
                        icon: 'fa-solid fa-fish',
                        images: ['https://dynamic-media-cdn.tripadvisor.com/media/photo-o/2d/f2/a0/1e/caption.jpg?w=900&h=500&s=1',
                                  'https://svcstrg.cld.navitime.jp/imgfile/02301_1503733_01.jpg'],
                        mapLink: 'https://maps.app.goo.gl/iZUZ4kU5Fd5gJitc9',
                        details: { distance: '100km', transport: '自駕 2h', stay: '車程' }
                    },
                    {
                        date: 22,
                        title: '北海道大學',
                        location: '札幌市區',
                        time: '14:00',
                        category: 'Sightseeing',
                        desc: '漫步於校園內的「白楊木林蔭道」與「銀杏並木」，感受北國學府的寧靜雪景。',
                        icon: 'fa-solid fa-graduation-cap',
                        image: 'https://resource02.ulifestyle.com.hk/ulcms/content/article/image/w600/ut/20181126130916_1_Dsrb0VTUwAA5xLQ.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=KEIKYU+EX+INN+Haneda5',
                        suggestion: '校內禁止遊客停車，請停正門旁收費停車場',
                        parking: '正門附近 Coin Parking (約400円/hr)',
                        details: { distance: '市區', transport: '自駕', stay: '1.5小時' }
                    },
                    {
                        date: 22,
                        title: '入住 Airbnb (放行李)',
                        location: '札幌市區',
                        time: '15:30',
                        category: 'Stay',
                        desc: '入住位於札幌的 Airbnb 民宿。稍作休息，準備晚上的逛街行程。',
                        icon: 'fa-solid fa-house-user',
                        images: [
                            'https://a0.muscache.com/im/pictures/hosting/Hosting-U3RheVN1cHBseUxpc3Rpbmc6MTUwOTg5OTcyODkyNTI1Mjk4Mg==/original/6a9e98b6-f65e-4c79-a37c-6fe7e2c19f9f.png?im_w=1440',
                            'https://a0.muscache.com/im/pictures/hosting/Hosting-U3RheVN1cHBseUxpc3Rpbmc6MTUwOTg5OTcyODkyNTI1Mjk4Mg==/original/0891bfb0-08b3-4138-8b19-aada9920e40d.png?im_w=1440'
                        ],
                        currentImageIndex: 0,
                        mapLink: 'https://www.airbnb.com/l/B6IGd7Ac',
                        details: { distance: '市區', transport: '自駕', stay: '連住兩晚' }
                    },
                    {
                        date: 22,
                        title: '狸小路商店街 (逛街)',
                        location: '札幌市中心',
                        time: '17:00',
                        category: 'Shopping',
                        desc: '前往著名的狸小路商店街。這裡有藥妝店、唐吉訶德、伴手禮店，是購物的天堂。',
                        icon: 'fa-solid fa-bag-shopping',
                        image: 'https://static.gltjp.com/glt/data/article/21000/20464/20231008_150003_159bcca1_w1920.webp',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Tanukikoji+Shopping+Street',
                        suggestion: '推薦 K-Park 或附近收費停車場',
                        parking: '周邊收費停車場 (約300-400円/30分)',
                        details: { distance: '市區', transport: '自駕/步行', stay: '3小時' }
                    },
                    {
                        date: 23,
                        title: '國營瀧野鈴蘭丘陵公園',
                        location: '札幌南區',
                        time: '09:30',
                        category: 'Activity',
                        desc: '冬季開園首日！盡情體驗長達200公尺的輪胎滑雪(Tube Sledding)、雪地漫步等雪上活動。',
                        icon: 'fa-solid fa-snowflake',
                        image: 'https://www.conventionsapporo.jp/files/UNIQUE_VENUES/309/vmg_1132_3.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Takino+Suzuran+Hillside+Park',
                        parking: '園區停車場 (420日圓/次)',
                        details: { distance: '20km', transport: '自駕 45分', stay: '3小時' }
                    },
                    {
                        date: 23,
                        title: '午餐：Restaurant Moai',
                        location: '真駒內瀧野靈園',
                        time: '12:30',
                        category: 'Sightseeing',
                        desc: '探訪安藤忠雄設計的「頭大佛」與壯觀的摩艾石像群。午餐可在園區內的 Restaurant Moai 享用。',
                        icon: 'fa-solid fa-monument',
                        images: [
                            'https://www.settour.com.tw/ss_img/poi/20230329/41089eb9-f96e-423d-8f1c-5ad8f729f634.jpg',
                            'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj1po5ieP4pcWQ1mXVDYgHQknJDoC88vePheWDKk4G1qFuH0WdETku8r4QqZfB2WaEPv_lsn9UJcfVd-KeseymxahfwOfINTIKYWgV8tco5OrkxOfLS3kAF0JnJUCn2AtMIzgRD6Dd_GEQ/s0-rw/92504.jpg'
                        ],
                        currentImageIndex: 0,
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Hill+of+the+Buddha',
                        parking: '靈園免費停車場',
                        details: { distance: '10分', transport: '車程', stay: '2小時' }
                    },
                    {
                        date: 23,
                        title: '慕尼黑聖誕市集',
                        location: '大通公園 2丁目',
                        time: '15:30',
                        category: 'Event',
                        desc: '感受濃厚的歐洲聖誕氛圍！逛逛德式木屋攤位，品嚐熱紅酒、烤杏仁，挑選精緻的聖誕飾品。',
                        icon: 'fa-solid fa-tree',
                        image: 'https://s.yimg.com/ny/api/res/1.2/QwSlX5eq2talr9vUldCqYQ--/YXBwaWQ9aGlnaGxhbmRlcjt3PTkzNTtoPTUxNA--/https://media.zenfs.com/zh-Hant-TW/homerun/klook_32/8087b4d122e8c84ee8d5dba37b0892a1',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Sapporo+Munich+Christmas+Market',
                        parking: '大通地下停車場 (收費)',
                        details: { distance: '市區', transport: '自駕回市區', stay: '自由' }
                    },
                    {
                        date: 23,
                        title: '晚餐：禪 (ZEN) 壽喜燒',
                        location: '南2條西1丁目',
                        time: '20:15',
                        category: 'Dinner',
                        desc: '預約席。享用高品質的和牛壽喜燒與涮涮鍋放題。地址：山口中央ビル B1F。',
                        icon: 'fa-solid fa-utensils',
                        image: 'https://res.klook.com/images/fl_lossy.progressive,q_65/c_fill,w_1200,h_630/activities/kgmhrra98qsyzudelofl/%E5%8C%97%E6%B5%B7%E9%81%93%E7%89%9B%E8%82%89%E6%B6%AE%E6%B6%AE%E9%8D%8B%E5%A3%BD%E5%96%9C%E7%87%92%E7%A6%AAZen-%E6%9C%AD%E5%B9%8C-Klook%E9%A6%99%E6%B8%AF.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Zen+Sukiyaki+Sapporo',
                        parking: '附近收費停車場',
                        details: { distance: '步行', transport: '5-8分鐘', stay: '晚餐' }
                    },
                    {
                        date: 24,
                        title: '前往支笏湖 & 午餐',
                        location: '支笏湖畔',
                        time: '11:30',
                        category: 'Drive',
                        desc: '離開札幌，前往日本最北的不凍湖—支笏湖。在湖畔餐廳 (推薦 Log Bear) 享用午餐，欣賞湖光山色。',
                        icon: 'fa-solid fa-water',
                        image: 'https://cdn.esence.travel/2023/09/fKM8nHaa-erin-1200-%C3%97-737-%E5%83%8F%E7%B4%A0.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Lake+Shikotsu',
                        parking: '支笏湖畔停車場 (500日圓/次)',
                        details: { distance: '45km', transport: '自駕 1h', stay: '2小時' }
                    },
                    {
                        date: 24,
                        title: '入住 翠山亭',
                        location: '支笏湖温泉',
                        time: '15:00',
                        category: 'Hotel',
                        desc: '入住「支笏湖第一寶亭留 翠山亭」。享受一泊二食的奢華溫泉體驗，度過寧靜浪漫的平安夜。',
                        icon: 'fa-solid fa-hot-tub-person',
                        images: ['https://pix8.agoda.net/hotelImages/9066267/898231137/0dae99d386321200728d083105a64012.jpg?ce=0&s=1024x',
                        'https://pix8.agoda.net/hotelImages/9066267/898231137/16c815457ea5ee796f94dcf0e88edb37.jpg?ce=0&s=1024x',
                        'https://pix8.agoda.net/hotelImages/9066267/898231137/e6739130e859092916a75b642da7882b.jpg?ce=0&s=1024x'],
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Shikotsuko+Daiichi+Hotel+Suizantei',
                        parking: '飯店專用停車場 (免費)',
                        details: { distance: '湖畔', transport: '步行', stay: '一泊二食' }
                    },
                    {
                        date: 25,
                        title: '聖誕晨間溫泉 & 早餐',
                        location: '翠山亭',
                        time: '09:00',
                        category: 'Relax',
                        desc: '在支笏湖的寧靜中醒來，享受晨間溫泉與精緻的日式早餐，度過悠閒的聖誕早晨。',
                        icon: 'fa-solid fa-mug-hot',
                        image: 'https://blog-imgs-61.fc2.com/v/i/o/violetfactory/201310301938308b2.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Shikotsuko+Daiichi+Hotel+Suizantei',
                        details: { distance: '飯店內', transport: '放鬆', stay: '至退房' }
                    },
                    {
                        date: 25,
                        title: '入住 新札幌 Airbnb',
                        location: '厚別區 (新札幌)',
                        time: '15:00',
                        category: 'Stay',
                        desc: '前往位於新札幌的寬敞 Airbnb。這裡交通便利，適合家庭聚會。',
                        icon: 'fa-solid fa-house-chimney',
                        images: ['https://a0.muscache.com/im/pictures/miso/Hosting-32963798/original/fd9b9c75-a508-4672-87ec-2cf9bd5f3720.jpeg?im_w=720',
                        'https://a0.muscache.com/im/pictures/miso/Hosting-32963798/original/32031044-3db0-486a-9536-f93e943913ab.jpeg?im_w=1440',
                        'https://a0.muscache.com/im/pictures/hosting/Hosting-U3RheVN1cHBseUxpc3Rpbmc6MzI5NjM3OTg=/original/919c706b-2ad7-4f32-ae72-69097c8c66d5.jpeg?im_w=1440'],
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Shin+Sapporo+Guest+House+Airbnb+32963798',
                        parking: '民宿停車位 (免費/有頂棚)',
                        details: { distance: '40km', transport: '自駕 1h', stay: '過夜' }
                    },
                    {
                        date: 25,
                        title: '聖誕大餐採購',
                        location: 'AEON 新札幌店',
                        time: '16:30',
                        category: 'Shopping',
                        desc: '前往附近的大型超市「AEON 新札幌店」採買聖誕晚餐食材。這裡食材種類豐富，非常適合準備大餐。',
                        icon: 'fa-solid fa-cart-shopping',
                        image: 'https://obs.line-scdn.net/0h3QZ3L0BqbH5nSkRAhf8TKV4cYA9ULnl4CTImEUVJMU1Jfjd4Di8kBEdIOklWKSwqUzB2HkcfZRlOKSwqDy4',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Aeon+Shin-Sapporo',
                        parking: '商場停車場 (購物可折抵)',
                        //suggestion: '推薦買北海道產牛排與海鮮！',
                        details: { distance: '5分', transport: '車/步行', stay: '1.5小時' }
                    },
                    {
                        date: 26,
                        title: '出發前往小樽',
                        location: '新札幌 -> 小樽',
                        time: '08:00',
                        category: 'Drive',
                        desc: '從民宿出發，沿著札樽自動車道前往小樽。車程約 45 分鐘。',
                        icon: 'fa-solid fa-car',
                        image: 'https://rimage.gnst.jp/livejapan.com/public/article/detail/a/10/00/a1000055/img/basic/a1000055_main.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Otaru',
                        details: { distance: '40km', transport: '自駕 45分', stay: '車程' }
                    },
                    {
                        date: 26,
                        title: '小樽散策',
                        location: '小樽運河 & 堺町通',
                        time: '09:00',
                        category: 'Sightseeing',
                        desc: '漫步小樽運河，參觀北一硝子本館、音樂盒堂。欣賞美麗的聖誕燈飾。',
                        icon: 'fa-solid fa-camera-retro',
                        image: 'https://a.travel-assets.com/findyours-php/viewfinder/images/res70/500000/500039-sakaimachi-street.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Otaru+Canal',
                        suggestion: '推薦停車：小樽市觀光停車場',
                        parking: '付費停車場 (1日約600-800円)',
                        details: { distance: '步行', transport: '散步', stay: '3小時' }
                    },
                    {
                        date: 26,
                        title: '小樽午餐',
                        location: '壽司通 / 三角市場',
                        time: '12:00',
                        category: 'Lunch',
                        desc: '推薦：政壽司、魚真或三角市場海鮮丼。',
                        icon: 'fa-solid fa-utensils',
                        image: 'https://img.bigfang.tw/2018/09/1535893649-7e7aee8d9bcfe9d8175fca2027809d59.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Masa+Zushi+Otaru',
                        suggestion: '政壽司有專用停車場',
                        parking: '政壽司: 免費 / 魚真: 附近收費',
                        details: { distance: '市區', transport: '自駕', stay: '1.5小時' }
                    },
                    {
                        date: 26,
                        title: '市區購物 & 閒逛',
                        location: '小樽市區',
                        time: '13:30',
                        category: 'Shopping',
                        desc: '在前往天狗山之前，先在市區購買伴手禮 (LeTAO, 六花亭等)。',
                        icon: 'fa-solid fa-bag-shopping',
                        image: 'https://www.tabirai.net/localinfo/cms/wp-content/uploads/2024/09/unnamed-71.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=LeTAO+Main+Store+Otaru',
                        details: { distance: '堺町通', transport: '步行', stay: '1.5小時' }
                    },
                    {
                        date: 26,
                        title: '天狗山 (日落/夜景)',
                        location: '天狗山纜車',
                        time: '15:00',
                        category: 'Sightseeing',
                        desc: '開車前往天狗山，欣賞從黃昏到夜晚的絕美景色 (日落約 16:05)。山上有免費停車場。',
                        icon: 'fa-solid fa-mountain',
                        image: 'https://www.bubu-jp.com/wp-content/uploads/2024/03/pixta_42128372_M.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Otaru+Tenguyama+Ropeway',
                        suggestion: '免費停車場 (150台)',
                        parking: '天狗山停車場 (免費)',
                        details: { distance: '15分', transport: '自駕', stay: '2小時' }
                    },
                    {
                        date: 26,
                        title: '返回新札幌 & 晚餐',
                        location: '新札幌 / 厚別',
                        time: '17:00',
                        category: 'Drive',
                        desc: '下山後開車返回民宿。晚餐可選擇在附近的 AEON Mall 或厚別區餐廳享用。',
                        icon: 'fa-solid fa-car-side',
                        image: 'https://d1grca2t3zpuug.cloudfront.net/2022/09/aeoninfo01.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Shin-Sapporo+Station',
                        details: { distance: '40km', transport: '自駕 50分', stay: '晚餐' }
                    },
                    {
                        date: 27,
                        title: '自駕前往美瑛',
                        location: '新札幌 -> 美瑛',
                        time: '08:00',
                        category: 'Drive',
                        desc: '出發前往美瑛，直奔深山的白金溫泉區。',
                        icon: 'fa-solid fa-car',
                        image: 'https://www.visit-hokkaido.jp/lsc/upfile/courseDetail/0000/0393/393_1_l.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Biei',
                        details: { distance: '130km', transport: '自駕 2.5h', stay: '車程' }
                    },
                    {
                        date: 27,
                        title: '白金溫泉區：冬日雪徑徒步',
                        location: '美瑛白金溫泉',
                        time: '10:30',
                        category: 'Hiking',
                        desc: '抵達白金溫泉，開啟雪地徒步。先前往「白鬚瀑布」欣賞藍色河流，再步行至森林中的「白金不動瀑布」。請穿著防滑鞋。',
                        icon: 'fa-solid fa-person-hiking',
                        images: [
                            'https://cdn.esence.travel/6-274.png',
                            'https://www.visit-hokkaido.jp/lsc/upfile/spot/0001/1198/11198_5_l.jpg',
                            
                        ],
                        currentImageIndex: 0,
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Shirahige+Waterfall',
                        suggestion: '免費停車場',
                        parking: '白金觀光中心停車場 (免費)',
                        details: { distance: '山區', transport: '自駕', stay: '2小時' }
                    },
                    {
                        date: 27,
                        title: '午餐：美瑛咖哩烏龍麵',
                        location: 'Family Restaurant Daimaru',
                        time: '12:30',
                        category: 'Lunch',
                        desc: '前往美瑛市區，品嚐當地靈魂美食「美瑛咖哩烏龍麵」。這家是當地人氣名店！',
                        icon: 'fa-solid fa-utensils',
                        image: 'https://i0.wp.com/anise.tw/wp-content/uploads/2014/07/1491818307-f6cf647f8788cc56a4323a0d07e5a49b.jpg?w=620&ssl=1', // Udon generic
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Daimaru+Biei',
                        suggestion: '市區有公共停車場',
                        parking: '附近公共停車場 (免費)',
                        details: { distance: '20km', transport: '自駕 25分', stay: '1.5小時' }
                    },
                    {
                        date: 27,
                        title: '美瑛小鎮 & 拼布之路',
                        location: '美瑛',
                        time: '14:00',
                        category: 'Sightseeing',
                        desc: '開車遊覽拼布之路（Ken & Mary 之樹），並在美麗的美瑛小鎮閒逛、喝咖啡。',
                        icon: 'fa-solid fa-tree',
                        image: 'https://www.biei-hokkaido.jp/wp3/wp-content/uploads/2023/10/fove_photo03.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Ken+and+Mary+Tree',
                        details: { distance: '周邊', transport: '自駕', stay: '3小時' }
                    },
                    {
                        date: 27,
                        title: '返回新札幌 & 晚餐 蕎麥麵',
                        location: '新札幌 / 厚別',
                        time: '17:00',
                        category: 'Drive',
                        desc: '結束充實的一天，開車返回民宿。晚餐在厚別周邊享用。',
                        icon: 'fa-solid fa-car-side',
                        image: 'https://tblg.k-img.com/resize/640x360c/restaurant/images/Rvw/276987/7821b56fb938d21fd1a050bdc225e8bc.jpg?token=aceb874&api=v2',
                        mapLink: 'https://maps.app.goo.gl/CBT11khkREBJC9N48',
                        details: { distance: '140km', transport: '自駕 2.5h', stay: '晚餐' }
                    },
                    {
                        date: 28,
                        title: '自然醒 & 出發',
                        location: '厚別民宿',
                        time: '10:00',
                        category: 'Relax',
                        desc: '享受一個睡到自然醒的早晨。悠閒地吃過早餐後，約 10:30 出發前往第一個景點。',
                        icon: 'fa-solid fa-bed',
                        image: 'https://cdn.hk01.com/di/media/images/1027313/org/c0b21971f03cb391f9d928d080c1b2c2.jpg/o1ZHC3iEdY_VwfxWTRBzCFlt-gXqKG3qSE-hYUhPoWE?v=w1920',
                        mapLink: '',
                        details: { distance: '民宿', transport: '休息', stay: '至10:30' }
                    },
                    {
                        date: 28,
                        title: '羊之丘展望台',
                        location: '羊之丘',
                        time: '10:30',
                        category: 'Sightseeing',
                        desc: '與著名的克拉克博士像合影 ("Boys, be ambitious!")，欣賞札幌市區的雪景全景。',
                        icon: 'fa-solid fa-binoculars',
                        image: 'https://tahokkaido.com/wp-content/uploads/2024/12/hitsujigaoka07.webp',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Hitsujigaoka+Observation+Hill',
                        suggestion: '免費停車場',
                        parking: '展望台停車場 (免費)',
                        details: { distance: '15km', transport: '自駕 30分', stay: '1.5小時' }
                    },
                    {
                        date: 28,
                        title: '午餐：湯咖哩',
                        location: '札幌市區',
                        time: '12:00',
                        category: 'Lunch',
                        desc: '在前往神宮的途中享用午餐。推薦：奧芝商店或 Suage+ (如果還沒吃過的話)。',
                        icon: 'fa-solid fa-utensils',
                        image: 'https://p1-634a4370.imageflux.jp/w=768,f=webp:auto,q=78/https%3A%2F%2Fdomingo.ne.jp%2Fwp%2Fwp-content%2Fuploads%2F2024%2F06%2Fc8c4c931ee2a3b48e2762cc687c8e829.jpg',
                        mapLink: 'https://maps.app.goo.gl/tszTD9t1JzVYXyQY8',
                        parking: '建議停附近收費停車場',
                        details: { distance: '市區', transport: '自駕', stay: '1.5小時' }
                    },
                    {
                        date: 28,
                        title: '北海道神宮',
                        location: '圓山公園',
                        time: '13:30',
                        category: 'Sightseeing',
                        desc: '參拜北海道總鎮守。冬天的神宮在雪中顯得格外莊嚴寧靜。',
                        icon: 'fa-solid fa-torii-gate',
                        image: 'https://static.gltjp.com/glt/data/article/21000/20333/20250417_021356_a715cd32_w1920.webp',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Hokkaido+Shrine',
                        suggestion: '停車費：參拜者免費1小時',
                        parking: '神宮停車場 (參拜者免費1小時)',
                        details: { distance: '10km', transport: '自駕 20分', stay: '1.5小時' }
                    },
                    {
                        date: 28,
                        title: '白色戀人公園 (點燈)',
                        location: '札幌西區',
                        time: '15:30',
                        category: 'Sightseeing',
                        desc: '傍晚前往，剛好可以欣賞戶外的聖誕點燈 (Illumination)，非常浪漫。',
                        icon: 'fa-solid fa-cookie-bite',
                        image: 'https://res.klook.com/images/fl_lossy.progressive,q_65/c_fill,w_720,h_479/w_44,x_8,y_8,g_south_west,l_Klook_water_br_trans_yhcmh3/activities/huyfjmri477kfv6qrbrr/%E6%8B%BC%E8%BB%8A%E9%81%8A%E8%A6%BD%E6%97%A5%E6%9C%AC%E6%9C%AD%E5%B9%8C%E4%B8%80%E6%97%A5%E9%81%8A%EF%BC%88%E7%99%BD%E8%89%B2%E6%88%80%E4%BA%BA%E5%85%AC%E5%9C%92%E6%9C%9D%E9%87%8C%E5%B7%9D%E6%BA%AB%E6%B3%89%E5%B0%8F%E6%A8%BD%E9%81%8B%E6%B2%B3%E7%AB%A5%E8%A9%B1%E5%8D%81%E5%AD%97%E8%B7%AF%E2%80%8B%E2%80%8B%E5%8F%A3%EF%BC%89.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Shiroi+Koibito+Park',
                        suggestion: '付費停車場 (1000円/h)',
                        parking: '公園停車場 (付費，購物可折抵)',
                        details: { distance: '15分', transport: '自駕', stay: '1.5小時' }
                    },
                    {
                        date: 28,
                        title: '迴轉壽司 Toriton (晚餐)',
                        location: '豐平店 (好停車)',
                        time: '18:00',
                        category: 'Dinner',
                        desc: '北海道當地人氣第一的迴轉壽司！食材新鮮、份量大。推薦：生干貝、大牡丹蝦。',
                        icon: 'fa-solid fa-fish',
                        image: 'https://svcstrg.cld.navitime.jp/imgfile/02301_1503733_01.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Toriton+Toyohira',
                        suggestion: '無法預約，建議提早去抽號碼牌',
                        parking: '專用免費停車場',
                        details: { distance: '市區', transport: '自駕 20分', stay: '1.5小時' }
                    },
                    {
                        date: 29,
                        title: '前往三井 Outlet',
                        location: '北廣島',
                        time: '10:30',
                        category: 'Shopping',
                        desc: '退房後，前往前往機場順路的「三井 Outlet Park 札幌北廣島」進行最後採購。',
                        icon: 'fa-solid fa-bags-shopping',
                        image: 'https://mitsui-shopping-park.com/lalaport/msp-info/cms/wp-content/uploads/MOP_kitahiroshima__04.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Mitsui+Outlet+Park+Sapporo+Kitahiroshima',
                        parking: 'Outlet 免費停車場',
                        details: { distance: '15km', transport: '自駕 20分', stay: '3小時' }
                    },
                    {
                        date: 29,
                        title: 'AEON Mall 千歲店 (購物)',
                        location: '千歲市',
                        time: '15:00',
                        category: 'Shopping',
                        desc: '前往機場附近最大的購物中心 AEON Mall。這裡超市很大，適合買最後的零食伴手禮。',
                        icon: 'fa-solid fa-cart-shopping',
                        image: 'https://obs.line-scdn.net/0h3QZ3L0BqbH5nSkRAhf8TKV4cYA9ULnl4CTImEUVJMU1Jfjd4Di8kBEdIOklWKSwqUzB2HkcfZRlOKSwqDy4',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Aeon+Chitose',
                        parking: '商場免費停車場',
                        details: { distance: '25km', transport: '自駕 30分', stay: '1.5小時' }
                    },
                    {
                        date: 29,
                        title: '入住 千歲 Airbnb',
                        location: '千歲市中心',
                        time: '18:00',
                        category: 'Stay',
                        desc: '入住千歲市區的民宿，整理行李，準備明天一早前往機場。地址：5-18-24 Shinonomecho。',
                        icon: 'fa-solid fa-house-chimney',
                        images: ['https://a0.muscache.com/im/pictures/d25e7b3d-602e-485e-a50a-bf72ba796cd7.jpg?im_w=1200',
                        'https://a0.muscache.com/im/pictures/aa37aa2f-74c9-4b76-9484-fb8d9bbd63f1.jpg?im_w=1440',
                        'https://a0.muscache.com/im/pictures/6b054ac7-bd13-4d4a-9fad-1ce2f6514a5c.jpg?im_w=1440'],
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=5-18-24+Shinonomecho+Chitose',
                        parking: '民宿停車位',
                        details: { distance: '市區', transport: '自駕', stay: '過夜' }
                    },
                    {
                        date: 30,
                        title: '早起 & 出發 (NH052)',
                        location: '千歲市區',
                        time: '05:45',
                        category: 'Departure',
                        desc: '05:45 起床梳洗。06:30 出發前往租車公司還車 (務必準時，08:30 飛機)。',
                        icon: 'fa-solid fa-bell',
                        image: 'https://a0.muscache.com/im/pictures/d25e7b3d-602e-485e-a50a-bf72ba796cd7.jpg?im_w=1200',
                        mapLink: '',
                        suggestion: '務必 06:45 前抵達租車公司',
                        details: { distance: '民宿', transport: '準備', stay: '45分' }
                    },
                    {
                        date: 30,
                        title: 'Budget 租車還車',
                        location: '新千歲機場店',
                        time: '06:45',
                        category: 'Car Rental',
                        desc: '抵達 Budget 租車點還車 (記得加滿油)。搭乘接駁車前往機場國內線航廈。',
                        icon: 'fa-solid fa-key',
                        image: 'https://www.budgetrentacar.co.jp/images/sys/shop/main_0700_1.jpg',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Budget+Car+Rental+New+Chitose+Airport',
                        details: { distance: '機場旁', transport: '自駕/接駁', stay: '30分' }
                    },
                    {
                        date: 30,
                        title: '早班機 NH052 (CTS->HND)',
                        location: '新千歲機場',
                        time: '08:30',
                        category: 'Flight',
                        desc: '搭乘 08:30 班機飛往東京。抵達後開始最後的購物衝刺！',
                        icon: 'fa-solid fa-plane-departure',
                        image: 'https://hk.wamazing.com/media/wp-content/uploads/sites/5/2019/09/shinchitoseairporttaxfree_pixta_94252250_M-853x569.jpg.webp',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=New+Chitose+Airport',
                        suggestion: '建議 07:00 抵達機場辦理還車/登機',
                        details: { distance: '東京', transport: '飛行', stay: '航程' }
                    },
                    {
                        date: 30,
                        title: '東京銀座購物',
                        location: '銀座 (Ginza)',
                        time: '13:00',
                        category: 'Shopping',
                        desc: '抵達東京並寄放行李後，前往銀座。這裡有最新的時尚精品、Uniqlo 旗艦店與各種伴手禮。',
                        icon: 'fa-solid fa-bag-shopping',
                        image: 'https://static.gltjp.com/glt/data/article/21000/20831/20241101_160121_0e37c684_w1920.webp',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Ginza',
                        details: { distance: '市區', transport: '電車', stay: '4小時' }
                    },
                    {
                        date: 30,
                        title: '入住 KEIKYU EX INN',
                        location: '天空橋站',
                        time: '19:00',
                        category: 'Hotel',
                        desc: '再次入住交通便利的 KEIKYU EX INN。晚餐可選擇羽田機場花園的餐廳，早點休息準備明天回程。',
                        icon: 'fa-solid fa-bed',
                        images: [
                            'https://pix8.agoda.net/hotelImages/16791240/803978242/bc74de46d2361212f60426dc71338600.jpg?ce=0&s=1024x',
                            'https://pix8.agoda.net/hotelImages/16791240/803978242/b69c0182316827d1c477e36427be07c3.jpg?ce=0&s=1024x',
                            'https://pix8.agoda.net/hotelImages/16791240/803978242/1bd9a4da30ccb7860ad744bfa3f47ae3.jpg?ce=0&s=1024x'
                        ],
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=KEIKYU+EX+INN+Haneda+Innovation+City',
                        details: { distance: '機場旁', transport: '步行/接駁', stay: '過夜' }
                    },
                    {
                        date: 31,
                        title: '早起退房 & 機場早餐',
                        location: '羽田機場 T3',
                        time: '06:40',
                        category: 'Departure',
                        desc: '09:20 的班機，建議 06:40 抵達第三航廈。辦理登機後，在機場內的江戶小路或出境區享用早餐。',
                        icon: 'fa-solid fa-passport',
                        image: 'https://lh7-us.googleusercontent.com/WjfbIrlhtJ-Z7HwnV6h7fXSfhk0ZOgfZG-fI7yJ4MqxAPtXYUoj6L3RUnAxWS6rqfjNEEgscg0NPRJutSOZS3LW_50-XEycs8gIHwrEafiIMImvLvbYBtTo5HaJtXBii3Nxro_y-sYXR9aGcCkeHdUU',
                        mapLink: 'https://www.google.com/maps/search/?api=1&query=Haneda+Airport+Terminal+3',
                        suggestion: 'NH923 09:20 起飛',
                        details: { distance: '回國', transport: '飛行', stay: '再見' }
                    }
                ])

                const filteredItinerary = computed(() => itineraryData.value.filter(item => item.date === selectedDate.value))

                // STORAGE & LOGIC
                const savedExpenses = localStorage.getItem('trip_expenses');
                const expenses = ref(savedExpenses ? JSON.parse(savedExpenses) : [{ title: '機場星巴克', amount: 800, date: '12/20' }]);
                const savedBudget = localStorage.getItem('trip_budget');
                const budgetAmount = ref(savedBudget ? JSON.parse(savedBudget) : 200000);
                const isEditingBudget = ref(false);
                const budgetInputRef = ref(null);
                
                const savedShopping = localStorage.getItem('trip_shopping');
                const shoppingList = ref(savedShopping ? JSON.parse(savedShopping) : [{ name: '白色戀人', checked: false }]);
                const newItem = ref('');
                const newItemImage = ref(null);
                const isCompressing = ref(false);

                watch(expenses, (newVal) => localStorage.setItem('trip_expenses', JSON.stringify(newVal)), { deep: true })
                watch(budgetAmount, (newVal) => localStorage.setItem('trip_budget', JSON.stringify(newVal)))
                watch(shoppingList, (newVal) => {
                    try {
                        localStorage.setItem('trip_shopping', JSON.stringify(newVal))
                    } catch (e) {
                        alert('儲存空間不足，請刪除部分項目或圖片！');
                    }
                }, { deep: true })

                const newExpense = ref({ title: '', amount: '' })
                const addExpense = () => { if(newExpense.value.title && newExpense.value.amount) { 
                    const now = new Date();
                    const dateStr = `${now.getMonth() + 1}/${now.getDate()}`;
                    expenses.value.unshift({ title: newExpense.value.title, amount: newExpense.value.amount, date: dateStr }); 
                    newExpense.value = { title: '', amount: '' }; 
                } };
                const deleteExpense = (index) => { if(confirm('確定要刪除這筆支出嗎？')) expenses.value.splice(index, 1); };
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                const remaining = computed(() => budgetAmount.value - totalExpense.value);
                const totalExpenseHkd = computed(() => (totalExpense.value * 0.052).toFixed(0));
                const editBudget = () => { isEditingBudget.value = true; nextTick(() => { if(budgetInputRef.value) budgetInputRef.value.focus(); }); };
                const saveBudget = () => { isEditingBudget.value = false; if(budgetAmount.value < 0) budgetAmount.value = 0; };
                const getIcon = (title) => { if(title.includes('食') || title.includes('拉麵')) return '🍜'; return '💸'; };
                const getExpenseBg = (dateStr) => {
                    const day = parseInt(dateStr.split('/')[1]) || 0;
                    const colors = ['bg-red-50', 'bg-orange-50', 'bg-yellow-50', 'bg-lime-50', 'bg-green-50', 'bg-teal-50', 'bg-cyan-50', 'bg-sky-50', 'bg-blue-50', 'bg-indigo-50', 'bg-violet-50', 'bg-purple-50', 'bg-fuchsia-50', 'bg-pink-50', 'bg-rose-50'];
                    return colors[day % colors.length];
                };

                // IMAGE COMPRESSION LOGIC (CRITICAL FIX)
                const resizeImage = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const maxWidth = 800; // Limit width to 800px
                                let width = img.width;
                                let height = img.height;
                                if (width > maxWidth) {
                                    height *= maxWidth / width;
                                    width = maxWidth;
                                }
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                                resolve(canvas.toDataURL('image/jpeg', 0.7)); // Compress to 70% quality JPEG
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                };

                const handleFileChange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        isCompressing.value = true;
                        try {
                            const resizedImage = await resizeImage(file);
                            newItemImage.value = resizedImage;
                        } catch (error) {
                            console.error("Compression failed", error);
                            alert("圖片處理失敗");
                        } finally {
                            isCompressing.value = false;
                        }
                    }
                };
                
                const clearImage = () => { newItemImage.value = null; };

                const addItem = () => {
                    if(newItem.value) { 
                        shoppingList.value.push({ 
                            name: newItem.value, 
                            checked: false,
                            image: newItemImage.value 
                        }); 
                        newItem.value = '';
                        newItemImage.value = null;
                    }
                };
                const deleteShoppingItem = (index) => { if(confirm('確定要刪除這個項目嗎？')) shoppingList.value.splice(index, 1); };
                const imageError = (e) => { e.target.src = 'https://placehold.co/600x400?text=No+Image'; }; // Fixed error source

                // LIGHTBOX & SNOW
                const lightboxState = reactive({ show: false, image: '' });
                const openLightbox = (imgUrl) => { lightboxState.image = imgUrl; lightboxState.show = true; };
                const closeLightbox = () => { lightboxState.show = false; };
                const handleScroll = (e, item) => {
                    const scrollLeft = e.target.scrollLeft;
                    const width = e.target.clientWidth;
                    const newIndex = Math.round(scrollLeft / width);
                    if (item.currentImageIndex !== newIndex) item.currentImageIndex = newIndex;
                };

                onMounted(() => {
                    const snowContainer = document.getElementById('snow-container');
                    const createSnowflake = () => {
                        const snowflake = document.createElement('div');
                        snowflake.classList.add('snowflake');
                        snowflake.innerHTML = Math.random() > 0.5 ? '❄' : '•';
                        snowflake.style.left = Math.random() * 100 + 'vw';
                        const size = Math.random() * 8 + 6; 
                        snowflake.style.fontSize = size + 'px';
                        snowflake.style.opacity = Math.random() * 0.5 + 0.3;
                        snowflake.style.animationDuration = (Math.random() * 10 + 15) + 's';
                        snowflake.style.animationDelay = Math.random() * 5 + 's';
                        snowContainer.appendChild(snowflake);
                        setTimeout(() => snowflake.remove(), 25000); 
                    };
                    for(let i=0; i<8; i++) setTimeout(createSnowflake, i * 500);
                    setInterval(createSnowflake, 800);
                });

                return {
                    activeTab, dates, selectedDate, hourlyWeather, filteredItinerary,
                    expenses, newExpense, addExpense, deleteExpense, totalExpense, getIcon, getExpenseBg,
                    budgetAmount, isEditingBudget, editBudget, saveBudget, budgetInputRef, remaining, totalExpenseHkd,
                    shoppingList, newItem, addItem, deleteShoppingItem, newItemImage, handleFileChange, tabTitles, imageError,
                    currentLocationName, weatherLoading, lightboxState, openLightbox, closeLightbox, handleScroll,
                    currentMapUrl, savedLocations, updateMap, isCompressing, clearImage
                }
            }
        }).mount('#app')
    </script>
</body>
</html>